{% comment %}
# Copyright 2011 Domogik project

# This file is part of Domogik.
# Domogik is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.

# Domogik is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.

# You should have received a copy of the GNU General Public License
# along with Domogik.  If not, see <http://www.gnu.org/licenses/>.

# Plugin purpose 
# ==============
# Support Z-wave technology
# Implements user interface for domoweb
# ==============
# Author : Nico <nico84dev@gmail.com>
{% endcomment %}

{% load i18n %}
{% load text %}
<script type="text/javascript" src="{% url django.views.i18n.javascript_catalog %}"></script>
<script type="text/javascript" src="{{ static_design_url }}/libraries/jquery.dataTables-1.8.2/js/jquery.dataTables.min.js"></script>
<script type="text/javascript" src="{{ static_design_url }}/admin/js/page-admin-ozwlib.js"> </script>

<script type='text/javascript'>

   $(function(){
    var infoNode ={};
    var devices = new Array();

    function dlgInfoValue (vData) {
         $('#tipsUpdCmdClss').html(vData.help);
         $('#divcmdclassdialog').dialog_form('open',{
                title: 'Node ' + vData.nodeId  +' : {% trans "Command Class informations." %} ',
                values: {upcmdclss : vData.commandClass, upcmdclssvalue : vData.value, upcmdclssunit : vData.units},
                onok: function(values) {
                    var self = this;
                    // Submit form
                    console.log("envois de la commande......");
                    }
         });
    };
       
    function setStatusZW(status) {
        if (status=='up') { //active
            textstatus = "En cours d'execution";
        } else { //inactive
            textstatus = "Stoppé";
        }
        $("#iconstatuszw").empty()
            .attr('class', "icon16-text-right icon16-status-plugin-" + status)
            .html("<span class='label'>Etat:</span><span class='offscreen'>" + textstatus + "</span>");
        }
        
    function GetinfoNode (nodeid) {
        infoNode ={};
        if (nodeid) {
                var msg = {};
                msg['command'] = "Refresh";
                var val = {};
                val['request'] ='GetNodeInfo';
                val['node'] =nodeid;
                msg['value'] = SetDataToxPL (val);
                rinor.put(['api', 'command', 'ozwave', 'UI'], msg)
                    .done(function(data, status, xhr){
                        infoNode = GetDataFromxPL(data, 'data');
                        var dt=JSON.stringify(infoNode);
                        console.log("Dans getinfonode : " + infoNode['Model']);
                        $.notification('debug',"Node : " + infoNode['Model'] + " info refreshed" );
                        RefreshTabHtml(infoNode);
                        return  infoNode;
                    })
                    .fail(function(jqXHR, status, error){
                       if (jqXHR.status == 400)
                            $.notification('error', "{% trans "Data not sent" %} (" + jqXHR.responseText + ") please check your device configuration");
                            infoNode['Node'] =   nodeid;
                            infoNode['Model'] = "NodeId not define";
                            return infoNode;
                    });
        }else { infoNode['Model'] = "NodeId not define";
                console.log("Dans getinfonode  pas de nodeid " + infoNode['Model']);   
                return infoNode;
                } 
        };
    function GetinfoValuesNode (nodeid, callback) {
        var valuesNode = [];
        var messXpl = {};
        if (nodeid) {
                var msg = {};
                msg['command'] = "Refresh";
                var val = {};
                val['request'] ='GetNodeValuesInfo';
                val['node'] =nodeid;
                msg['value'] = SetDataToxPL (val);
                rinor.put(['api', 'command', 'ozwave', 'UI'], msg)
                    .done(function(data, status, xhr){
                        messXpl = ParseAckXPL(data.xpl);
                        if (messXpl['count'] != 0) {
                            var thOut = Object.keys(messXpl['value0']);  // Hypothèse, vrais pour l'intant, toutes les lignes on les mêmes entêtes !
                            thOut.unshift('Num', 'realValue');
                            var RowN = [];
                            var hdCmdClss = {};
                            for (i=0; i<thOut.length; i++) {
                                hdCmdClss[thOut[i]]= i;
                                };
                            for (i=0; i<messXpl.count; i++) {
                                valuesNode[i]= messXpl['value' + i];
                                var R = [];
                                R[0] = i + 1;
                                R[1] = valuesNode[i]['value'];
                                for (ii=2; ii<thOut.length;ii++) {
                                    R[ii] = valuesNode[i][thOut[ii]]
                                    }
                                RowN[i] = R;
                            }
                            console.log("Dans GetinfoValuesNode : " + RowN);
                            callback(thOut);
                            var idDetNode = '#detNode' + nodeid;
                            $(idDetNode).dataTable({
                                    "bFilter": false,
                                    "bJQueryUI": true,
                                    "aLengthMenu": [[10, 25, 50, -1], [10, 25, 50, "All"]],
                                    "bAutoWidth": false,
                                    "aoColumnDefs": [  
                                        { "fnRender": function (oObj) {return renderCmdClssNode(oObj);}, "aTargets": [0] },
                                        { "fnRender": function (oObj) {return renderCmdClssValue(oObj);}, "aTargets": [hdCmdClss['value']] },                                                           
                                        { "fnRender": function (oObj) {return renderCmdClssName(oObj);}, "aTargets": [hdCmdClss['commandClass']] },
                                        ], 
                                    "fnRowCallback": function( nRow, aData, iDisplayIndex ) {
                                        /* allocate change function for value the grade to the default row class name */
                                        oSettings = this.fnSettings();
                                        idRO= getDataTableColIndex(oSettings, 'readOnly');
                                        if (aData[idRO]== false) {
                                            id = "valCC" + aData[getDataTableColIndex(oSettings, 'id')];
                                            $('#' + id).change(function () {
                                                var nTr = this.parentNode.parentNode;
                                                if (this.name =='CmdClssValue') {
                                                        var oTable = $("#" + nTr.parentElement.parentElement.id).dataTable();
                                                        var aPos = oTable.fnGetPosition(this.parentElement );
                                                        var idC= getDataTableColIndex(oSettings, 'value');
                                                        var ok = oTable.fnUpdate(this.value,aPos[0],idC);
                                                };
                                            });
                                        }
                                        return nRow;
                                    },
                                    "aaData": RowN
                                    });
                            for (i=0; i<thOut.length; i++) {
                                if (thOut[i] == 'realValue' | thOut[i] == 'nodeId' | thOut[i] == 'homeId' | thOut[i] == 'domogikdevice' | thOut[i] == 'help' | thOut[i] == 'readOnly' | thOut[i] == 'listElems') {
                                    $(idDetNode).dataTable().fnSetColumnVis( i, false ); };
                                }  // redirection des events change des values read
                            return valuesNode;
                        }  else { // le Node n'as pas de command_class
                            var thOut =[];
                            thOut[0]="No Command_Class";
                            console.log("Dans GetinfoValuesNode no Cmd-Class : " + thOut);
                            callback(thOut);                                                    
                        };
                    })
                    .fail(function(jqXHR, status, error){
                       if (jqXHR.status == 400)
                            $.notification('error', "{% trans "Data not sent" %} (" + jqXHR.responseText + ") please check your device configuration");
                            valuesNode['Node'] =   nodeid;
                            valuesNode['Model'] = "NodeId not define";
                            return valuesNode;
                    });
        }else { valuesNode['Model'] = "NodeId not define";
                console.log("Dans GetinfoValuesNode  pas de nodeid : " + nodeid);   
                return valuesNode;
                } 
        };

        $("#specialsubmit").click(function(){
            var dmg_addr = $("#dmg_addr").val();
            var info_node = 'Actualiser';
            var msg = {};
            var netWorkZW ={};
            setStatusZW('down');
            msg['command'] = "Refresh";
            var val = {};
            val['request'] ='GetNetworkID';
            msg['value'] = SetDataToxPL (val);
            rinor.put(['api', 'command', 'ozwave', 'UI'], msg)
                .done(function(data, status, xhr){
                    netWorkZW =GetDataFromxPL(data, 'data');
                    $('#confpath').html(netWorkZW['ConfigPath']);                    
                    $('#userpath').html(netWorkZW['UserPath']);                    
                    $('#libozwvers').html(netWorkZW['PYOZWLibVers']);
                    $('#ozwplugvers').html(netWorkZW['OZWPluginVers']);
                    if (netWorkZW['error'] ==""){
                        $('#homeid').html(netWorkZW['HomeID']);
                        $('#namectrl').html(netWorkZW['Model']);
                        $('#deviceadr').html(netWorkZW['Device']);
                        $('#numnodes').html(netWorkZW['Node count']);
                        $('#libctrl').html(netWorkZW['Library']);
                        $('#libctrlver').html(netWorkZW['Version']);                    
                        console.log("Dans Submit, .done: " + netWorkZW['Model']);
                        setStatusZW('up')
                        $.notification('debug',"device : " + netWorkZW['Primary controller'] + " info refreshed" );
                        var node_items = document.getElementById("node_items");
                        RefreshNodes(netWorkZW);
                    } else {
                        $('#homeid').html(netWorkZW['error']);
                        setStatusZW('down')
                    }
                })
                .fail(function(jqXHR, status, error){
                    $('#homeid').html("{% trans "Plugin not running" %}");
                    setStatusZW('down')
                    if (jqXHR.status == 400)
                        $.notification('error', "{% trans "Data not sent" %} (" + jqXHR.responseText + ") please check your device configuration");
               });
            });
    
    function RefreshNodes(netWorkZW) {
           console.log("Dans RefreshNode, après .done" + JSON.stringify(netWorkZW));
            if (netWorkZW) {
                var i=0;
                var nId=0;
                while (nId< netWorkZW.ListNodeId.length) {
                        infoNode = GetinfoNode(netWorkZW.ListNodeId[nId]);
                        console.log("While refreshnode nodeID: " + netWorkZW.ListNodeId[nId]);
                        i++;
                    nId++;
                    };
                };
            };
            
    function RefreshTabHtml(zwNode) {
        console.log("Dans RefreshTabHtml, " + zwNode);
        var node_items = document.getElementById("node_items");
        var nodeid=zwNode.Node;
        var iid= "node_" + nodeid;
        var dataT = $('#node_items').dataTable().fnGetData();
        var trfunct= function(li,dr){$('#node_items').dataTable().fnAddData(dr);};        
        if (dataT) {
            for (i=0; i<dataT.length; i++) {
                if (dataT[i][hdLiNode['NodeId']]==nodeid) {
                    var trfunct= function(li,dr){$('#node_items').dataTable().fnUpdate(dr,li);};
                    var li= i;
                    break;
                };
            };
        };
        trfunct(li, [zwNode.Node, zwNode.Name, zwNode.Location, zwNode.Model, zwNode['State sleeping'], zwNode.Type, zwNode['Last update'],""]);
        console.log("Dans RefreshTabHtml, DataTable : " + dataT[li] + "---" + zwNode.Model); 
     };   
     

// Callback event des commandes dans la table des nodes.
// Class button, 
    $('#node_items tbody td button').live('click', function () {
        var nTr = this.parentNode.parentNode;
        var aData = oTabNodes.fnGetData( nTr );
        if (this.title =='Update Node') {
            console.log("Dans click updatenode, DataTable : " + aData);   
            // Lancer la sauvegarde vers plugin
                var msg = {};
                msg['command'] = "Refresh";
                var val = {};
                val['request'] ='SetNodeNameLoc';
                val['node'] =aData[hdLiNode['NodeId']];
                val['newname'] = returnTextValue(aData[hdLiNode['Name']]);
                val['newloc'] = returnTextValue(aData[hdLiNode['Location']]);
                msg['value'] = SetDataToxPL (val);
                rinor.put(['api', 'command', 'ozwave', 'UI'], msg)
                    .done(function(data, status, xhr){
                        infoNode = GetDataFromxPL(data,  'data');
                        var dt=JSON.stringify(infoNode);
                        console.log("Dans Update Node : " + infoNode['Model']);
                        $.notification('debug',"Node : " + infoNode['Model'] + " name and  location update" );
                        RefreshTabHtml(infoNode);
                        return  infoNode;
                    })
                    .fail(function(jqXHR, status, error){
                       if (jqXHR.status == 400)
                            $.notification('error', "{% trans "Data not sent" %} (" + jqXHR.responseText + ") {% trans "please check your device configuration" %}");
                            infoNode['Node'] =   nodeid;
                            infoNode['Model'] = "NodeId not define";
                            return infoNode;
                    });
        };
        if (this.title =='Detail Node') {
            var t =  this.attributes["class"].value; //nodeValue
            if (t.search('action-del') != -1 ) {
			// This row is already open - close it 
                this.attributes["class"].value = "icon16-action-add buttonicon"; //nodeValue
                oTabNodes.fnClose( nTr );
            }else {
                // Open this row 
                this.attributes["class"].value = "icon16-action-del buttonicon"; //nodeValue
                //send update nodes values
                var values = GetinfoValuesNode(aData[hdLiNode['NodeId']], function(thOut){ oTabNodes.fnOpen( nTr, fnFormatDetails(nTr,thOut), 'simple' );});
            /*  console.log("click detail values : " + values); */
            };
        };
        if (this.title == 'Cmd class details') {
            var idDetNode = nTr.parentNode.parentNode.id;
            aData = $('#' + idDetNode).dataTable().fnGetData(nTr);
            editvalueNode(aData[hdCmdClss['id']], dlgInfoValue);
            console.log("Dans click updatenode, Cmd class details, DataTable : " + aData + nTr); 
         };
       if (this.name == 'Send value') {
            var idDetNode = nTr.parentNode.parentNode.id;
            var aTable = $('#' + idDetNode).dataTable();
            aData = aTable.fnGetData(nTr); 
            valueId = aData[getDataTableColIndex(aTable.fnSettings(), 'id')];
            console.log ("sending update cmd class");
            msg = setValueNode(valueId, aData[getDataTableColIndex(aTable.fnSettings(), 'value')], aTable,nTr);
            
        }else {
            console.log("Dans click button, DataTable : " + this.title); 
        };
    }); 
// class input   
$('#node_items tbody td input').live('keyup', function (e) {
   var nTr = this.parentNode.parentNode;
   var aData = oTabNodes.fnGetData( nTr );
   if (this.title =='Name') {
            aData[hdLiNode['Name']] = this.value;
            console.log("new value : " +aData);
        }
       else if (this.title =='Location') {
            aData[hdLiNode['Location']] = this.value;
            console.log("new value : " +aData);
        } else if (this.name =='CmdClssValue') {
                    console.log (" Dans Nom key down, CmdClssValue :" + nTr.id);
            } else {
                console.log("Dans Nom key down, input : " + this.title + "--" + this.value +"--" + this);
            };
    });

    $("#specialsave").click(function(){
        var msg = {};
        msg['command'] = "Refresh";
        msg['value'] = "|'request':'SaveConfig'\\";
        rinor.put(['api', 'command', 'ozwave', 'UI'], msg)
            .done(function(data, status, xhr){
            $.notification('info',"Request : " + " saving config ok" );
            })
            .fail(function(jqXHR, status, error){
                if (jqXHR.status == 400)
                    $.notification('error', "{% trans "Data not sent" %} (" + jqXHR.responseText + ") please check your device configuration");
            });
    });
    
   $(document).ready(function(){
         oTabNodes = $("#node_items").dataTable({
            "bFilter": false,
            "bAutoWidth": false,
            "aoColumnDefs": [  
                { "fnRender": function (oObj) {return setNameNode(oObj);}, "aTargets": [ hdLiNode['Name'] ] },
                { "fnRender": function (oObj) {return  "<input type='text' title='Location' value='" + 
                                                oObj.aData[hdLiNode['Location']] + "'/>";}, "aTargets": [ hdLiNode['Location'] ] },
                { "fnRender": function (oObj) {return setStatusSleep(oObj);}, "aTargets": [ hdLiNode['Awake'] ] },
                { "fnRender": function (oObj) {return setActionNode(oObj);}, "aTargets": [hdLiNode['Action'] ] },      
                { "bSortable": false, "aTargets": [ hdLiNode['Action'] ] }, 
                ],
            "aaSorting": [[0, 'asc']]
            } );
        var msg = {};
        msg['command'] = "Refresh";
        var val = {};
        val['request'] ='GetValueTypes';
        val['listetypes'] ='valuestype';
        msg['value'] = SetDataToxPL (val);
        rinor.put(['api', 'command', 'ozwave', 'UI'], msg)
            .done(function(data, status, xhr){
                listTypesVal = GetDataFromxPL(data, 'data');
                console.log("*** listTypesVal : " + listTypesVal);
            /*    for (type in listTypesVal) {
                    $('select#listtest').append("<option value='"+type+"'>"+type+"</option>");
                    }; */
                    // Gestion des commandes class sous forme de dialogue
                $('#divcmdclassdialog').dialog_form({
                        tips: "{% trans 'Update values of command class: ' %}" ,
                        tipsid: 'tipsUpdCmdClss',
                        fields: [
                            {name : 'upcmdclss', type:'text', label:"{% trans 'CommandClass' %}", required: false, options: {min: 1, max: 80}},
                            {name : 'upcmdclsstype', type:'select', label:"{% trans 'type' %}", required: false,
                                options: {
                                    placeholder: "{% trans 'select a type' %}",
                                },
                                items: [function(){
                                  it= [];
                                  for (type in listTypesVal )
                                    it.add("{value:'"+ type +"', label: '" + type +"'}");
                                   return it;
                                  }
                                ],
                            },
                            {name : 'upcmdclssvalue', type:'text', label:"{% trans 'Value' %}", required: false, options: {min: 1, max: 80}},
                            {name : 'upcmdclssunit', type:'text', label:'{% trans "Units" %}', required: false, options: {min: 1, max: 80}},
                            {name : 'upcmdclssdescription', type:'text', label:'{% trans "Description" %}', required: false, options: {min: 1, max: 80}},
                            {name : 'upcmdclssgenre', type:'text', label:'{% trans "Genre" %}', required: false, options: {min: 1, max: 80}}
                            ]
                    }); 
                })
            .fail(function(jqXHR, status, error){
               if (jqXHR.status == 400)
                    $.notification('error', '{% trans "Data not sent" %} (' + jqXHR.responseText + ') please check your device configuration');
            });
    
         rinor.get(['api', 'feature'])
            .done(function(data, status, xhr){
                var i=0;
                $.each(data.objects, function(index, object) {
                    devices[i]=[object.device_id,object.device_feature_model.stat_key,object.device.device_type_id,object.device_feature_model.value_type,object.device.address,object.device_feature_model.parameters,object.device_feature_model.name,object.device.name];
                    if (object.device_feature_model.feature_type == "actuator"){
                       $('select#alarmdevice').append("<option value='"+i+"'>"+object.device.name+" - "+object.device_feature_model.name+"</option>");
                    }
                    i=i+1;
                });
                console.log("devices.length : " + devices.length);
                for(i=0 ;i<devices[1].length;i++){
                    console.log("devices[1][" + i + "] : " + devices[1][i]);
                };
           })
            .fail(function(jqXHR, status, error){
                if (jqXHR.status == 400)
                    $.notification('error', "{% trans "Device list not retrieved" %} (" + jqXHR.responseText + ")");
            }); 
            

         $("#specialsubmit").click();
    });
});


</script>
<section class="subsection">

    <h2>{% trans "Zwave controller" %}  &nbsp;&nbsp;&nbsp;&nbsp;
            <div id='iconstatuszw'> <span class='label'>{% trans "Status"%}:</span>
          </div><div align="right"><font size=2>
                <span class='subtitle' id='libozwvers'><u>{% trans "Undefined"%}</u></span>&nbsp;&nbsp;&nbsp;&nbsp;
                <span class='label'>{% trans "Plugin version" %}:</span>&nbsp;<span class='subtitle' id='ozwplugvers'><u>{% trans "Undefined"%}</u></span>
            </font></div>
            </h2>
        <form id='controllerform'>
            <ul class='infos'>
                <li><font size=3>
                    <span class='label'>{% trans "Home ID" %}:</span>&nbsp;<span class='subtitle' id='homeid'><u>{% trans "Undefined" %}</u></span>
                </font> </li>
                 <li>
                    <span class='label'>{% trans "Contoller" %}:</span>&nbsp;<span class='subtitle' id='namectrl'><u>{% trans "Undefined" %}</u></span>
                    &nbsp;&nbsp;&nbsp;<span class='label'>{% trans "Device" %}:</span>&nbsp;<span class='subtitle' id='deviceadr'><u>{% trans "Undefined" %}</u></span>
                    &nbsp;&nbsp;&nbsp;<span class='label'>{% trans "Number of nodes" %}:</span>&nbsp;<span class='subtitle'  id='numnodes'><u>{% trans "Undefined" %}</u></span>
                </li>
                <li>
                    <span class='label'>{% trans "Library" %}:</span>&nbsp;<span class='subtitle'  id='libctrl'><u>{% trans "Undefined" %}</u></span>
                    &nbsp;&nbsp;&nbsp;<span class='label'>{% trans "Version" %}:</span>&nbsp;<span class='subtitle'  id='libctrlver'><u>{% trans "Undefined" %}</u></span>
                </li>
                <li>
                    <span class='label'>{% trans "Openzwave path configuration" %}:</span>&nbsp;<span class='subtitle' id='confpath'><u>{% trans "Undefined" %}</u></span>
                </li>
                <li>
                   <span class='label'>{% trans "User path" %}:</span>&nbsp;<span class='subtitle' id='userpath'><u>{% trans "Undefined" %}</u></span>
                </li>
            </ul>
        </form>
        <p>
            <button id='specialsubmit' class='button icon16-action-reset'>{% trans "Refresh" %}</button>
            <button id='specialsave' class='button icon16-action-save'>{% trans "Save config" %}</button> 
            <span class='subtitle'>{% trans " Updade Node button before saving" %}</span>
    <!--         <select id='listtest' class='list'>{% trans "liste test" %}</select>  -->
        </p>
</section>
<section class="subsection">
    <h2>{% trans "Zwave Network device" %}</h2>
    <table class='simple'><tbody>
        <tr>
            <td>{% trans "Description of zwave network with devices capacities" %}</td>
            <td></td>
            <td class='value icon16-status-primary'></td>
            <td> {% trans "Command Class available for domogik device" %}</td>
        </tr>
        <tr><td></td><td></td>
            <td class='value icon16-status-false'></td>
            <td> {% trans "Command Class not available for domogik device" %}</td>
         </tr>   
    </tbody></table>
    <p></p>
        <div id='networkform'>
            <table id='node_items' class='simple'>
                <thead>
                    <tr>
                        <th scope='col'>{% trans "NodeId" %}</th>
                        <th scope='col'>{% trans "Name" %}</th>
                        <th scope='col'>{% trans "Location" %}</th>
                        <th scope='col'>{% trans "Model" %}</th>
                        <th scope='col'>{% trans "Awake" %}</th>
                        <th scope='col'>{% trans "Type" %}</th>
                        <th scope='col'>{% trans "Last update" %}</th>
                        <th scope='col'>{% trans "Action" %}</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
        </table>
        </div>
</section>
<div id="divcmdclassdialog"></div>
