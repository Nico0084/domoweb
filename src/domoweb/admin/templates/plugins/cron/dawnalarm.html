{% comment %}
# Copyright 2011 Domogik project

# This file is part of Domogik.
# Domogik is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.

# Domogik is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.

# You should have received a copy of the GNU General Public License
# along with Domogik.  If not, see <http://www.gnu.org/licenses/>.

# Author : SÃ©bastien GALLET <bibi21000@gmail.com>
{% endcomment %}

{% load i18n %}

<link rel="stylesheet" media="all" type="text/css" href="{{ static_design_url }}/llibraries/jquery-ui-1.8.16.custom/css/smoothness/jquery-ui-1.8.16.custom.css" />
<link rel="stylesheet" media="all" type="text/css" href="{{ static_design_url }}/libraries/jquery-ui-timepicker/css/jquery-ui-timepicker-addon.css" />

<script type="text/javascript" src="{{ static_design_url }}/libraries/jquery-ui-timepicker/js/jquery-ui-timepicker-addon.js"></script>
<script type="text/javascript" src="{{ static_design_url }}/libraries/jquery-ui-timepicker/js/jquery-ui-sliderAccess.js"></script>

<script type='text/javascript'>
    var devices = new Array();

    $(function(){

        $("#specialcreatedawnalarm").click(function(){
             var rinor_ip = "{{ request.session.rinor_ip }}";
             var rinor_port = "{{ request.session.rinor_port }}";
             var name = "";
             var devicetype = "dawnalarm";
             //When creating device in UI, we use rinor has nested schema
             var nstschema = "rinor";
             var nstdevice = "";
             var nstid = 0;
             var nsttechno = "";
             var nstcommand = "";
             var nstvalue0 = "";
             var alarm = "";
             if($('select#dawnalarmdevice').val() != 0){
                    nstdevice = devices[$("select#dawnalarmdevice").val()][4];
                    nstid = devices[$("select#dawnalarmdevice").val()][0];
                    var testvalue = devices[$("select#dawnalarmdevice").val()][2].split(".");
                    nsttechno = testvalue[0];
                    testvalue = devices[$("select#dawnalarmdevice").val()][5];
                    testvalue = testvalue.replace(/&quot;/g,'"');
                    var obj = jQuery.parseJSON(testvalue);
                    //console.log("obj.command : " + obj['command']);
                    nstcommand = obj['command'];
             };
             name = $("#dawnalarmname").val();
             alarm = $("#dawnalarmdays").val() + "," + $("#dawnalarmstarthour").val();
             alarm = alarm + "-" + $("#dawnalarmstophour").val();
             if (($("#dawnalarmdimlevels").val() != null) && ($("#dawnalarmdimlevels").val() != "")) {
                    alarm = alarm + "," + $("#dawnalarmdimlevels").val();
             };
             var value = "{ 'device':'" + name + "','devicetype':'" + devicetype +
                         "','alarm':'" + alarm +
                         "','nst-schema':'" + nstschema + "','nst-device':'" + nstdevice +
                         "','nst-techno':'" + nsttechno + "','nst-command':'" + nstcommand +
                         "','nst-value0':'" + "0" +
                         "','rinorip':'" + rinor_ip + "','rinorport':'" + rinor_port + "'}";

             rinor.put(['api', 'command', 'cron', 'UI'], {"command":"create-dawnalarm", 'value' : value})
                .done(function(data, status, xhr){
                     test=JSON.stringify(data);
                     debut=test.search('error=');
                     if (debut != -1) {
                        test=test.slice(debut+5);
                        fin=test.search('}');
                        test=test.slice(1,fin-2);
                        $.notification('error',test);
                     }else{
                        $("#speciallist").click();
                        $.notification('info',"Alarm " + name + " created");
                     }
                })

                .fail(function(jqXHR, status, error){
                    if (jqXHR.status == 400)
                        $.notification('error', "{% trans "Can't create dawnalarm" %} (" + jqXHR.responseText + ")");
                });
        });

      $(document).ready(function(){
        var i=1;
        //$('#dawnalarmstarthour').timepicker({});
        //$('#dawnalarmstophour').timepicker({});
        rinor.get(['api', 'feature'])
            .done(function(data, status, xhr){
                $.each(data.objects, function(index, object) {
                    devices[i]=[object.device_id,object.device_feature_model.stat_key,object.device.device_type_id,object.device_feature_model.value_type,object.device.address,object.device_feature_model.parameters,object.device_feature_model.name,object.device.name];
                    if (object.device_feature_model.feature_type == "actuator" && object.device_feature_model.value_type == "range") {
                       $('select#dawnalarmdevice').append("<option value='"+i+"'>"+object.device.name+" - "+object.device_feature_model.name+"</option>");
                    }
                    i=i+1;
                });
                //console.log("devices.length : " + devices.length);
                //for(i=0 ;i<devices[1].length;i++){
                //    console.log("devices[1][" + i + "] : " + devices[1][i]);
                //}
                $("select#dawnalarmdevice").change();
           })
            .fail(function(jqXHR, status, error){
                if (jqXHR.status == 400)
                    $.notification('error', "{% trans "Device list not retrieved" %} (" + jqXHR.responseText + ")");
            });
     });
    });

</script>
<section class="subsection">
    <h3>{% trans "Create a dawn alarm." %}</h3>
    <p>{% trans "With this kind of timer, you could turn your dimmer in a dawn simulator. You can specify the begin and the end hours of the cycle. You can also defined your own dim levels, specialy if your lights blink with the default values. You can specify up to 10 dim levels." %}</p>
            <fieldset>
                <legend><h4>{% trans 'Name'%}</h4></legend>
                    <table>
                        <tr>
                            <td><label for='dawnalarmname'>{% trans 'The name of the alarm / device.' %}</label></td>
                            <td><input type='text' id='dawnalarmname' name='name'/></td>
                        </tr>
                    </table>
            </fieldset>
            <fieldset>
                <legend><h4>{% trans 'Days and hours'%}</h4></legend>
                    <table>
                        <tr>
                            <td><label for='dawnalarmdays'>{% trans 'The days of the week : a combination of MoTuWeThFrSaSu' %}</label></td>
                            <td><input type='text' id='dawnalarmdays' name='days'/></td>
                        </tr>
                        <tr>
                            <td><label for='dawnalarmstarthour'>{% trans 'The begin of the dawn cycle (ie 8:00).' %}</label></td>
                            <td><input type='text' id='dawnalarmstarthour' name='starthour'/></td>
                        </tr>
                        <tr>
                            <td><label for='dawnalarmstophour'>{% trans 'The end of the awn cycle (ie 11:00).' %}:</label></td>
                            <td><input type='text' id='dawnalarmstophour' name='stophour'/></td>
                        </tr>
                    </table>
            </fieldset>
            <fieldset>
                <legend><h4>{% trans 'Device to use'%}</h4></legend>
                    <table>
                        <tr>
                            <td><label for='dawnalarmdevice'>{% trans "Device" %}:</label></td>
                            <td><select id="dawnalarmdevice" class='listes' style="width:30em;"></select></td>
                        </tr>
                        <tr>
                            <td><label for='dawnalarmdimlevels'>{% trans 'The dim levels to use, separated by commas. Could be left blank.' %}:</label></td>
                            <td><input type='text' id='dawnalarmdimlevels' name='stophour'/></td>
                        </tr>
                    </table>
            </fieldset>
        <p>
            <button id='specialcreatedawnalarm' class='button icon16-action-save'>{% trans "Create" %}</button>
            <button id='specialcanceldawnalarm' class='button icon16-action-reset'>{% trans "Cancel" %}</button>
        </p>
</section>


