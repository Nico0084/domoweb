{% comment %}
# Copyright 2011 Domogik project

# This file is part of Domogik.
# Domogik is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.

# Domogik is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.

# You should have received a copy of the GNU General Public License
# along with Domogik.  If not, see <http://www.gnu.org/licenses/>.

# Author : SÃ©bastien GALLET <bibi21000@gmail.com>
{% endcomment %}

{% load i18n %}
<script type='text/javascript'>

    $(function(){
        $("#specialsubmit").click(function(){
            var dmg_addr = $("#dmg_addr").val();
            var cmd_addr = $("#cmd_addr").val();
            var cmd_type = $("#cmd_type").val();
            var stat_addr = $("#stat_addr").val();
            var stat_type = $("#stat_type").val();
            var read = $("#read").is(':checked');
            var comment = $("#comment").val();
            if (dmg_addr) {
                if(cmd_addr||stat_addr){
                var value = dmg_addr + ':' + cmd_addr + ':' + cmd_type + ':' + stat_addr + ':' + stat_type + ':' + read+':'+comment;
                rinor.put(['api', 'command', 'knx', 'UI'], {"command":'Add', "value":value})
                    .done(function(data, status, xhr){
                         test=JSON.stringify(data);
                         debut=test.search('data=');
                         test=test.slice(debut+4);
                         fin=test.search('}');
                         test=test.slice(1,fin-2);
                         if (test.search('Error')>=0){
                            $.notification('error', test);
                         }else{
                         $.notification('info',test );
                         $("#specialread").click();
                         }
                    })
                    .fail(function(jqXHR, status, error){
                        if (jqXHR.status == 400)
                            $.notification('error', "{% trans "Data not sent" %} (" + jqXHR.responseText + ")");
                    });
                }else {
                $.notification('error', "{% trans "Need Command group or Stat group address field should be filled" %}")
                }
            } else {
                $.notification('error', "{% trans "Domogik device address field should be filled" %}");
            }
        });

        $("#specialcreatealarm").click(function(){
            cont=true
            var mess = {};
            mess['command'] = "start";
            mess['value'] = $("#alarmtype").val();
            //mess['caller'] = "UI";
            //mess['alarmtype'] = $("#alarmtype").val();
            var iid=$("#name").val();
            //mess['device'] = iid;
            var starthour = $("#starthour").val();
            var stophour = $("#stophour").val();
            var days = $("#days").val();
            var alarm="";
            if ((stophour != null) && (stophour != "")) {
                mess['value'] = days + ',' + starthour + ':' + stophour;
            } else {
                mess['value'] = days + ',' + starthour;
            }
            mess['nst-xpltype'] = $("#xpltype").is(':selected');
            mess['nst-schema'] = $("#schema").val();
            mess['parameter0'] = $("#parameter0").val();
            mess['valueon0'] = $("#valueon0").val();
            mess['valueoff0'] = $("#valueoff0").val();
            var field0 = $("#field0").val();
            mess['nst-'+field0] = $("#value0").val();
            var field1 = $("#field1").val();
            if ((field1 != null) && (field1 != "")) {
                mess['nst-'+field1] = $("#value1").val();
            }
            //alert(JSON.stringify(mess));
            if (cont) {
                rinor.put(['api', 'command', 'cron', iid], mess)
                    .done(function(data, status, xhr){
                         test=JSON.stringify(data);
                         debut=test.search('data=');
                         test=test.slice(debut+4);
                         fin=test.search('}');
                         test=test.slice(1,fin-2);
                         if (test.search('Error')>=0){
                            $.notification('error', test);
                         }else{
                         $.notification('info',test );
                         $("#specialread").click();
                         }
                    })
                    .fail(function(jqXHR, status, error){
                        if (jqXHR.status == 400)
                            $.notification('error', "{% trans "Data not sent" %} (" + jqXHR.responseText + ")");
                    });
                }else {
                $.notification('error', "{% trans "Need Command group or Stat group address field should be filled" %}")
                }
        });

   $("#speciallist").click(function() {
            rinor.put(['api', 'command', 'cron', 'UI'], {"command":'list'})
               .done(function(data, status, xhr){
                     //alert(JSON.stringify(data));
                     var test=JSON.stringify(data);
                     var debut=test.search('devices=');
                     test=test.slice(debut+7);
                     var fin=test.search('}');
                     test=test.slice(1,fin-2);
                     //alert(test);
                     var devices=eval(test);
                     var reg=new RegExp("[|]+", "g");
                     i=0;
                     var cron_items=document.getElementById("cron_items");
                     while(cron_items.rows.length>1)
                         cron_items.deleteRow(cron_items.rows.length-1);
                     $("#cron_items tbody").append("<tr id='" + iid + "'></tr>");
                     do {
                           var device=devices[i];
                           i=i+1;
                           //alert(device);
                           var data=device.split(reg);
                           var iid=data[0];
                           var devicetype=data[1];
                           var status=data[2];
                           var runs=data[3];
                           var aps=data[4];
                           var uptime=data[5];
                           var uptimeh = parseFloat(uptime)/3600;
                           var uptimed = parseFloat(uptime)/3600/24;
                           var runtime=data[6];
                           var runtimeh = parseFloat(runtime)/3600;
                           $("#cron_items tbody").append("<tr id='" + iid + "'></tr>");
                           var tr = $("tr#"+iid);
                           tr.append("<td>" +  iid + "</td>");
                           tr.append("<td>" + devicetype + "</td>");
                           tr.append("<td>" + status + "</td>");
                           tr.append("<td>" + runs + "</td>");
                           tr.append("<td>" + aps + "</td>");
                           tr.append("<td>" + uptime + " / " + uptimeh.toFixed(2) + " / " + uptimed.toFixed(2) + "</td>");
                           tr.append("<td>" + runtime + " / " + runtimeh.toFixed(2) + "</td>");
                           tr.append("<td>" + "&nbsp;" + "</td>");
                     }
                     while (i<devices.length);
                })
                .fail(function(jqXHR, status, error){
                    if (jqXHR.status == 400)
                        $.notification('error', "{% trans "Cant get list" %} (" + jqXHR.responseText + ")");
                });
        });

   $("#specialdelete").click(function(){
      var ligne = $("#ligne_to_delete").val();
                value="Delete:"+ligne
                rinor.put(['api', 'command', 'knx', 'UI'], {"command":'Add', "value":value})
                    .done(function(data, status, xhr){
                     $.notification('info','Ligne deleted' );
                     $("#specialread").click();
                     $("#specialread").click();
                     })
                    .fail(function(jqXHR, status, error){
                        if (jqXHR.status == 400)
                            $.notification('error', "{% trans "Data not sent" %} (" + jqXHR.responseText + ")");
                    });
     });


   $("#specialread").click(function(){
      data="";
      rinor.put(['api', 'command', 'knx', 'UI'], {"command":'Add', "value":"Request"})
                    .done(function(data, status, xhr){
                         test=JSON.stringify(data);
                         debut=test.search('data=');
                         test=test.slice(debut+4);
                         fin=test.search('}');
                         test=test.slice(1,fin-2);
                         i=0;
                         text="<u>Config file:</u> <br/>"
                         do{
                           i=i+1;
                           next=test.search(',');
                           text=text+"<br/>" +i+" - "+ test.slice(0,next);
                           test=test.slice(next+1);
             }
             while (test.search(",")>=0);
                         $('#demo').html(text);
                         }
                    )
                    .fail(function(jqXHR, status, error){
                        if (jqXHR.status == 400)
                            $.notification('error', "{% trans "Data not sent" %} (" + jqXHR.responseText + ")");
                   });
      });
    $("")
    });
</script>
<section class="subsection">
    <h2>{% trans "Cron jobs" %}</h2>
    <div id='cron_list'>
        <p><button id='speciallist' class='button icon16-action-save'>{% trans "List" %}</button></p>
        <table id='cron_items' class='simple'>
            <thead>
                <tr>
                    <th scope='col'>{% trans "id" %}</th>
                    <th scope='col'>{% trans "devicetype" %}</th>
                    <th scope='col'>{% trans "status" %}</th>
                    <th scope='col'>{% trans "runs" %}</th>
                    <th scope='col'>{% trans "aps" %}</th>
                    <th scope='col'>{% trans "uptime (s/h/d)" %}</th>
                    <th scope='col'>{% trans "runtime (s/h)" %}</th>
                    <th scope='col'>{% trans "commands" %}</th>
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>
    </div>
</section>
<section class="subsection">
    <h2>{% trans "Create an On/Off alarm" %}</h2>
    <p>{% trans "This type of alarm let's you send On/off message using a time interval." %}</p>
        <form id='alarmform'>
            <fieldset>
                <legend>{% trans 'Alarm informations'%}</legend>
                    <table>
                        <tr>
                            <td><label for='alarmtype'>{% trans 'Alarm type' %}:</label></td>
                            <td><input type='text' id='alarmtype' name='alarmtype' readonly="readonly" value="alarm"/></td>
                        </tr>
                        <tr>
                            <td><label for='name'>{% trans 'The bame of th alarm : you will use it to create a device.' %}:</label></td>
                            <td><input type='text' id='name' name='name'/></td>
                        </tr>
                        <tr>
                            <td><label for='days'>{% trans 'The days : a combination of MoTuWeThFrSaSu' %}:</label></td>
                            <td><input type='text' id='days' name='days'/></td>
                        </tr>
                        <tr>
                            <td><label for='starthour'>{% trans 'Start hour of the alarm (ie 8:00)' %}:</label></td>
                            <td><input type='text' id='starthour' name='starthour'/></td>
                        </tr>
                        <tr>
                            <td><label for='stophour'>{% trans 'Stop hour of the alarm (ie 11:00). Should be left blank for an infinite alarm.' %}:</label></td>
                            <td><input type='text' id='stophour' name='stophour'/></td>
                        </tr>
                    </table>
            </fieldset>
            <fieldset>
                <legend>{% trans 'Message to send'%}</legend>
                    <table>
                        <tr>
                            <td><label for='xpltype'>{% trans 'Xpl-type' %}:</label></td>
                            <td><select name="xpltype" id="xpltype">
                                    <option value="xpl-cmnd" selected="selected">xpl-cmnd</option>
                                    <option value="xpl-trig">xpl-trig</option>
                                    <option value="xpl-stat">xpl-stat</option>
                                </select></td>
                        </tr>
                        <tr>
                            <td><label for='schema'>{% trans 'Schema to use : telldus.basic, x10.basic, ...' %}:</label></td>
                            <td><input type='text' id='schema' name='schema'/></td>
                        </tr>
                        <tr>
                            <td><label for='parameter0'>{% trans 'The name of the command to use : command, dim, ...' %}:</label></td>
                            <td><input type='text' id='parameter0' name='parameter0'/></td>
                        </tr>
                        <tr>
                            <td><label for='valueon0'>{% trans 'The on value of the command to send : on, 100, ...' %}:</label></td>
                            <td><input type='text' id='valueon0' name='valueon0'/></td>
                        </tr>
                        <tr>
                            <td><label for='valueoff0'>{% trans 'The off value of the command to send : off, 0, ...' %}:</label></td>
                            <td><input type='text' id='valueoff0' name='valueoff0'/></td>
                        </tr>
                    </table>
            </fieldset>
            <fieldset>
                <legend>{% trans 'Device insformation'%}</legend>
                    <table>
                        <tr>
                            <td><label for='field0'>{% trans 'The adress field name : device, group,  ...' %}:</label></td>
                            <td><input type='text' id='field0' name='field0'/></td>
                        </tr>
                        <tr>
                            <td><label for='value0'>{% trans 'The value of the field address : TS14, A1, ...' %}:</label></td>
                            <td><input type='text' id='value0' name='value0'/></td>
                        </tr>
                        <tr>
                            <td><label for='field1'>{% trans 'The name of an optional field : house, group,  ...' %}:</label></td>
                            <td><input type='text' id='field1' name='field1'/></td>
                        </tr>
                        <tr>
                            <td><label for='value1'>{% trans 'The value of the optional field : A, ...' %}:</label></td>
                            <td><input type='text' id='value1' name='value1'/></td>
                        </tr>
                    </table>
            </fieldset>
        <p>
            <button id='specialcreatealarm' class='button icon16-action-save'>{% trans "Create" %}</button>
            <button id='specialcancel' class='button icon16-action-save'>{% trans "Cancel" %}</button>
        </p>
        </form>
</section>


