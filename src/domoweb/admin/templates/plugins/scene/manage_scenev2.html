{% load i18n %}
<script type='text/javascript'>
	var table = new Array();
	var nb_ligne=1;
	
function delscene(number) {
    alert(table[number]+ ' was delete')
    rinor.put(['api', 'command', 'scene', table[number][0]],  {"command":"delete"})
               .done(function(data, status, xhr){
                   rinor.delete(['api', 'device', table[number][1]])
                       .done(function(data, status, xhr){
                          alert(table[number][0]+ ' was delete')
                       })
               })  
};

function startscene(number) {

    rinor.put(['api', 'command', 'scene', table[number][0]], {"command":"start"})
               .done(function(data, status, xhr){
                      alert(table[number]+ ' was start')
                })
};
function stopscene(number) {

    rinor.put(['api', 'command', 'scene', table[number][0]], {"command":"stop"})
               .done(function(data, status, xhr){
                   alert(table[number]+ ' was stop')
                })
};


function delall(){
        for(i=1;i<nb_ligne;i++){
           testid='#device_scene_' + i;
           $('#device_scene_' + i).remove();
        }
};

  $(function(){
  
  $('#actualise').click(function () {
        delall();
        for(i=1;i<nb_ligne+10;i++){
           testid='#device_scene_' + i;
           $('#device_scene_' + i).remove();
        }
        table = [];        
        nb_ligne = 1;
        rinor.get(['api', 'feature'])
            .done(function(data, status, xhr){
                $.each(data.objects, function(index, object) {
                   if(object.device_feature_model.id=='scene.stat.status'){
                    nb_ligne++;
                    valeur_stat = 'unknow'
                    valeur_run = 'unknow'
                    table[nb_ligne] = [object.device.address,object.device_id];
                    rinor.get(['api','state','last','1',object.device_id, 'stats'])
                         .done(function(data, status, xhr){
                          valeur_stat = data[0].value;
                           rinor.get(['api','state','last','1',object.device_id, 'run'])
                            .done(function(data, status, xhr){
                               valeur_run = data[0].value;
                               matabme = "<tr class='scenetabrow' id='device_scene_iRef'><td>" + object.device.name +"</td><td>"+object.device.description +"</td><td> "+valeur_run+" </td><td> "+valeur_stat+" </td><td><input type='button' onClick='startscene(iRef)'/></td><td><input type='button' onClick='stopscene(iRef)'/></td><td><input type='button' onClick='delscene(iRef)'/></td></tr>"
                               $('#Scene_table').append(matabme.replace(/iRef/g, nb_ligne));
                             })
                      })
                    }
                    });
           })
            .fail(function(jqXHR, status, error){
                if (jqXHR.status == 400)
                    $.notification('error', '{% trans 'Device list not retrieved' %} (' + jqXHR.responseText + ')');
            });

    });




   $(document).ready(function(){
        table = [];
        nb_ligne=1;
        rinor.get(['api', 'feature'])
            .done(function(data, status, xhr){
                $.each(data.objects, function(index, object) {
  //tableau[i]=[object.device_id,object.device_feature_model.stat_key,object.device.device_type_id,object.device_feature_model.value_type,object.device.address,object.device_feature_model.parameters,object.device_feature_model.name,object.device.name];
                   if(object.device_feature_model.id=='scene.stat.status'){
                    nb_ligne++;
                    valeur_stat = 'unknow'
                    valeur_run = 'unknow'
                    table[nb_ligne] = [object.device.address,object.device_id];
                    rinor.get(['api','state','last','1',object.device_id, 'stats'])
                         .done(function(data, status, xhr){
                          valeur_stat = data[0].value;
                           rinor.get(['api','state','last','1',object.device_id, 'run'])
                            .done(function(data, status, xhr){
                               valeur_run = data[0].value;
                               matabme = "<tr class='scenetabrow' id='device_scene_iRef'><td>" + object.device.name +"</td><td>"+object.device.description +"</td><td> "+valeur_run+" </td><td> "+valeur_stat+" </td><td><input type='button' onClick='startscene(iRef)'/></td><td><input type='button' onClick='stopscene(iRef)'/></td><td><input type='button' onClick='delscene(iRef)'/></td></tr>"
                               $('#Scene_table').append(matabme.replace(/iRef/g, nb_ligne));
                             })                        
                      })
                    }
                    });
           })
            .fail(function(jqXHR, status, error){
                if (jqXHR.status == 400)
                    $.notification('error', '{% trans 'Device list not retrieved' %} (' + jqXHR.responseText + ')');
            });

    });
    });


</script>
<section class="subsection">
    <h2>{% trans "Manage Scene" %}</h2>
  <button id='actualise' class='button icon16-action-save' style='width:20em;'>{% trans 'Refresh' %}</button>
 <table id='Scene_table' class='simple'>
<thead>
                <tr>
                    <td></td>
                </tr>
   <tr>
       <th> Name </th>
       <th> Description </th>
       <th> Run </th>
       <th> Stat </th>
       <th> Start </th>
       <th> Stop </th>
       <th> Delete </th>
   </tr>
</table>


</section>

