{% load i18n %}
<script type='text/javascript'>
	var table = new Array();
	var nb_ligne=1;
       var plugin_scene_status = "OFF";
	
function delscene(number) {
    alert(table[number]+ ' was delete')
    rinor.put(['api', 'command', 'scene', table[number][0]],  {"command":"delete"})
               .done(function(data, status, xhr){
                   rinor.delete(['api', 'device', table[number][1]])
                       .done(function(data, status, xhr){
  //                        alert(table[number][0]+ ' was delete')
                       })
               })  
                $('#actualise').click();
};

function startscene(number) {

    rinor.put(['api', 'command', 'scene', table[number][0]], {"command":"start"})
               .done(function(data, status, xhr){
//                      alert(table[number]+ ' was start')
                })
                 $('#actualise').click();
};
function stopscene(number) {

    rinor.put(['api', 'command', 'scene', table[number][0]], {"command":"stop"})
               .done(function(data, status, xhr){
      //             alert(table[number]+ ' was stop')
                })
                 $('#actualise').click();
};


function delall(){
        for(i=1;i<nb_ligne;i++){
           testid='#device_scene_' + i;
           $('#device_scene_' + i).remove();
        }
};

  $(function(){
  
  $('#actualise').click(function () {
        delall();
        for(i=1;i<nb_ligne+10;i++){
           testid='#device_scene_' + i;
           $('#device_scene_' + i).remove();
        }
        table = [];        
        nb_ligne = 1;
        rinor.get(['api', 'feature'])
            .done(function(data, status, xhr){
                $.each(data.objects, function(index, object) {
                   if(object.device_feature_model.id=='scene.stat.status'){
                    nb_ligne++;
                    valeur_stat = 'unknow'
                    valeur_run = 'unknow'
                    table[nb_ligne] = [object.device.address,object.device_id];
                    rinor.get(['api','state','last','1',object.device_id, 'stats'])
                         .done(function(data, status, xhr){
                          valeur_stat = data[0].value;
                          
                           rinor.get(['api','state','last','1',object.device_id, 'run'])
                            .done(function(data, status, xhr){
                               valeur_run = data[0].value;
                               rinor.get(['api','plugin'])
                                   .done(function(data, status, xhr){
                                  for(i=0;i<data.objects[0]['list'].length;i++){
                                      if (data.objects[0]['list'][i]['id'] == "scene"){
                                          if(data.objects[0]['list'][i]['status'] == "OFF"){
                                              valeur_run = 'plugin stopped';
                                           }
                                       }
                                   }
                                   matabme = "<tr class='scenetabrow' id='device_scene_iRef'><td><center>" + object.device.name +"</center></td><td>"+object.device.description +"</td><td><center> "+valeur_run+"</center> </td><td><center> "+valeur_stat+" </center></td><td><input type='button' class='button icon16-action-save' style='width:5em;' onClick='startscene(iRef)'/></td><td><input type='button' class='button icon16-action-save' style='width:5em;' onClick='stopscene(iRef)'/></td><td><input type='button' class='button icon16-action-save' style='width:5em;' onClick='delscene(iRef)'/></td></tr>"
                                  $('#Scene_table').append(matabme.replace(/iRef/g, nb_ligne));
                               });
                               

                             })
                      })
                    }
                    });
           })
            .fail(function(jqXHR, status, error){
                if (jqXHR.status == 400)
                    $.notification('error', '{% trans 'Device list not retrieved' %} (' + jqXHR.responseText + ')');
            });

    });




   $(document).ready(function(){
   
        table = [];
        nb_ligne=1;
        rinor.get(['api', 'feature'])
            .done(function(data, status, xhr){
                $.each(data.objects, function(index, object) {
  //tableau[i]=[object.device_id,object.device_feature_model.stat_key,object.device.device_type_id,object.device_feature_model.value_type,object.device.address,object.device_feature_model.parameters,object.device_feature_model.name,object.device.name];
                   if(object.device_feature_model.id=='scene.stat.status'){
                    nb_ligne++;
                    valeur_stat = 'unknow'
                    valeur_run = 'unknow'
                    table[nb_ligne] = [object.device.address,object.device_id];
                    rinor.get(['api','state','last','1',object.device_id, 'stats'])
                         .done(function(data, status, xhr){
                          valeur_stat = data[0].value;
                          
                            rinor.get(['api','state','last','1',object.device_id, 'run'])
                            .done(function(data, status, xhr){
                               valeur_run = data[0].value;
                               rinor.get(['api','plugin'])
                                   .done(function(data, status, xhr){
                                  for(i=0;i<data.objects[0]['list'].length;i++){
                                      if (data.objects[0]['list'][i]['id'] == "scene"){
                                          if(data.objects[0]['list'][i]['status'] == "OFF"){
                                              valeur_run = 'plugin stopped';
                                           }
                                       }
                                   }
                                   matabme = "<tr class='scenetabrow' id='device_scene_iRef'><td><center>" + object.device.name +"</center></td><td>"+object.device.description +"</td><td><center> "+valeur_run+"</center> </td><td><center> "+valeur_stat+" </center></td><td><input type='button' class='button icon16-action-save' style='width:5em;' onClick='startscene(iRef)'/></td><td><input type='button' class='button icon16-action-save' style='width:5em;' onClick='stopscene(iRef)'/></td><td><input type='button' class='button icon16-action-save' style='width:5em;' onClick='delscene(iRef)'/></td></tr>"
                                  $('#Scene_table').append(matabme.replace(/iRef/g, nb_ligne));
                               });
                               

                             })
                      })
                    }
                    });
           })
            .fail(function(jqXHR, status, error){
                if (jqXHR.status == 400)
                    $.notification('error', '{% trans 'Device list not retrieved' %} (' + jqXHR.responseText + ')');
            });

    });
    });


</script>
<section class="subsection">
    <h2>{% trans "Manage Scene" %}</h2>
  <button id='actualise' class='button icon16-action-save' style='width:10em;'>{% trans 'Refresh' %}</button>
 <table id='Scene_table' class='simple'>
<thead>
                <tr>
                    <td></td>
                </tr>
   <tr>
       <th width=10%> Name </th>
       <th width=65%> Description </th>
       <th width=5%> Run </th>
       <th width=5%> Stat </th>
       <th width=5%> Start </th>
       <th width=5%> Stop </th>
       <th width=5%> Delete </th>
   </tr>
</table>


</section>

