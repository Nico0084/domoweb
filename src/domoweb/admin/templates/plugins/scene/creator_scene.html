{% load i18n %}
<script type='text/javascript'>
    $(function(){

        var tableau = new Array();
        
        $("select#features1").change(function(){
          var test = $(this).val();
          var test2 = $("select#TestFeature").val();
          if ((tableau[test][4]=="binary"||tableau[test][4]=="list") && (test2!="And" && test2!="Or" && test2!="None")){
             $("select#TestFeature option").remove();
             $("select#TestFeature").append("<option value='None'>----</option>");
             $("select#features2").hide();
             $("select#test2").hide();
             $("#value2").hide();
             test2 = $("select#TestFeature").val();
          }
          if (test != "" && (test2=="And" || test2=="Or"|| test2=="None")){
             $('select#test1 option').remove();
             $('select#test1').show();
             $('select#test1').append("<option value='None'>-----</option>");
             $('select#test1').append("<option value='='>=</option>");
             var feature=$("select#features1").val();
             var type=tableau[test][4];
             if (type=="number"|| type=="range"){
               $('select#test1').append("<option value='>'>></option>");
               $('select#test1').append("<option value='<'><</option>");
              }
          }else{
             $('select#test1').hide();
             $('#value1').hide();
          }
          $("select#test1").change();
        });    

        $("select#features2").change(function(){
          var test = $(this).val();
          var test2 = $("select#TestFeature").val();
          if (test != "" && (test2=="And" || test2=="Or")){
             $('select#test2').show();
          }else{
             $('select#test2').hide();
             $('#value2').hide();
          }
          $("select#test2").change();
        });    

        $("select#test1").change(function(){
           var test = $("select#features1").val();
           if (tableau[test][4]=="list"||tableau[test][4]=="binary"){
              $('select#test1').attr("disabled", true);
              $('select#test1 option[value="="]').attr("selected", "selected");
              $("#value1").html("<select id='Test_value1' style='width:20em;'></select>");
              $("select#TestFeature option").remove();
              $("select#TestFeature").append("<option value='None'>----</option>");
              $("select#TestFeature").append("<option value='And'>And</option>");
              $("select#TestFeature").append("<option value='Or'>Or</option>");
              var valeur = tableau[test][6];
              var test2 = tableau[test][4];
              valeur = valeur.replace(/&quot;/g,'"');
              var obj = jQuery.parseJSON(valeur);
              if (test2 == "binary"){
                 $("select#Test_value1").append("<option value='"+obj.value0+"'>"+obj.value0+"</option>");
                 $("select#Test_value1").append("<option value='"+obj.value1+"'>"+obj.value1+"</option>");
              }else{
                 for(i=0 ;i<obj.commandValues.length;i++){
                    $("select#Test_value1").append("<option value='"+obj.commandValues[i]+"'>"+obj.commandValues[i]+"</option>");
                 }
            }
            $("#value1").show();
          }else {
             $('select#test1').removeAttr("disabled");
             $("#value1").html("<input id='Test_value1' style='width:20em;'></input>");
             $("#value1").show();
             $("select#TestFeature option").remove();
             $("select#TestFeature").append("<option value='None'>----</option>");
             $("select#TestFeature").append("<option value='And'>And</option>");
             $("select#TestFeature").append("<option value='Or'>Or</option>");
             $("select#TestFeature").append("<option value='='>=</option>");
             $("select#TestFeature").append("<option value='>'>></option>");
             $("select#TestFeature").append("<option value='<'><</option>");
          }
          if ($(this).val()!="None" && ($("select#TestFeature").val()=="And" ||$("select#TestFeature").val()=="Or"   ||$("select#TestFeature").val()=="None")){
             $("#value1").show();
          }
          else $("#value1").hide();
        });

        $("select#test2").change(function(){
          var test = $("select#features2").val();
          if ((tableau[test][4]=="list"||tableau[test][4]=="binary")&&($("select#TestFeature").val!="None")){ 
            $('select#test2').attr("disabled", true);
            $('select#test2 option[value="="]').attr("selected", "selected");
            $("#value2").html("<select id='Test_value2' style='width:20em;'></select>");
            
            var valeur = tableau[test][6];
            var test2 = tableau[test][4];
            valeur = valeur.replace(/&quot;/g,'"');
            var obj = jQuery.parseJSON(valeur);
            if (test2 == "binary"){
             $("select#Test_value2").append("<option value='"+obj.value0+"'>"+obj.value0+"</option>");
             $("select#Test_value2").append("<option value='"+obj.value1+"'>"+obj.value1+"</option>");
             }
             else{
              for(i=0 ;i<obj.commandValues.length;i++){
             $("select#Test_value2").append("<option value='"+obj.commandValues[i]+"'>"+obj.commandValues[i]+"</option>");
             }}
            $("#value2").show();
          }
          else {
            $('select#test2').removeAttr("disabled");
            $("#value2").html("<input id='Test_value2' style='width:20em;'></input>");
            $("#value2").show();
          }
          
          if ($(this).val()!="None" && ($("select#TestFeature").val()=="And" ||$("select#TestFeature").val()=="Or"   ||$("select#TestFeature").val()=="None")){
             $("#value2").show();
          }
          else $("#value2").hide();
        });

        $("select#TestFeature").change(function(){
          var test= $("select#TestFeature").val();
          if (test != "None"){
             $("select#features2").show();
             if (test !="And" && test != "Or"){
                $("select#test1").hide();
                $("#value1").hide();
                $("select#test2").hide();
                $("#value2").hide();
                $("select#features2 option").remove();
                var feature1= $("select#features1").val();
                var taille=tableau.length;
                feature1=parseInt(feature1);
                for(i=1;i<tableau.length;i++){
                   var tab=tableau[i];
                   if (tableau[i][4]=="number"||tableau[i][4]=="range"){
                      if (i!=$("select#features1").val()){
                         $("select#features2").append("<option value='"+i+"'>"+tableau[i][8]+" - "+tableau[i][7]+"</option>");
                      }                
                   }  
                  }                
              }else{
                $("select#features2 option").remove();
                $("select#features2").append($("select#features1").clone().html());
                $("select#test1").show();
                $("#value1").show();
                $("select#test2").show();
                $("select#test2").change();
             }
             $("select#features2").change();
          }else{
             $("select#features2").hide();
             $("select#test2").hide();
             $("#value2").hide();
          }
        });

      $("select#sortieVrai").change(function(){
          var test = $("select#sortieVrai").val();
          var valeur = tableau[test][6];
          var test2 = tableau[test][4];    
          valeur = valeur.replace(/&quot;/g,'"');
          var obj = jQuery.parseJSON(valeur);
 
          if (tableau[test][4]=="list"||tableau[test][4]=="binary"){
          $("#valvrai").html("<select id='valueVrai' style='width:20em;'></select>");
          if (test2 == "binary"){
             $("select#valueVrai").append("<option value='"+obj.value0+"'>"+obj.value0+"</option>");
             $("select#valueVrai").append("<option value='"+obj.value1+"'>"+obj.value1+"</option>");
             }
           else{
             for(i=0 ;i<obj.commandValues.length;i++){
               $("select#valueVrai").append("<option value='"+obj.commandValues[i]+"'>"+obj.commandValues[i]+"</option>");
               }
             }

          }
          if (test2=="numeric"|| test2=="range"){
          $("#valvrai").html("<input id='valueVrai' style='width:20em;'></input>");
          }
          if (test2=="trigger"){      
             $("#valvrai").html("");
          }

      }
);

      $("select#sortieFaux").change(function(){
          var test = $("select#sortieFaux").val();
          var valeur = tableau[test][6];
          var test2 = tableau[test][4];    
          valeur = valeur.replace(/&quot;/g,'"');
          var obj = jQuery.parseJSON(valeur);
 
          if (tableau[test][4]=="list"||tableau[test][4]=="binary"){
          $("#valfaux").html("<select id='valueFaux' style='width:20em;'></select>");
          if (test2 == "binary"){
             $("select#valueFaux").append("<option value='"+obj.value0+"'>"+obj.value0+"</option>");
             $("select#valueFaux").append("<option value='"+obj.value1+"'>"+obj.value1+"</option>");
             }
             else{
               for(i=0 ;i<obj.commandValues.length;i++){
                 $("select#valueFaux").append("<option value='"+obj.commandValues[i]+"'>"+obj.commandValues[i]+"</option>");
               } 
             }

          }
          if (test2=="numeric"|| test2=="range"){
             $("#valfaux").html("<input id='valueFaux' style='width:20em;'></input>");
          }
          if (test2=="trigger"){      
             $("#valfaux").html("");
          }
      }
);

      $(document).ready(function(){
        var i=1;
        $('select#features1').append("<option value='0'>----------</option>");
        $('select#sortieVrai').append("<option value='0'>----------</option>");
        rinor.get(['api', 'feature'])
            .done(function(data, status, xhr){
                $.each(data.objects, function(index, object) {
                    tableau[i]=[object.device_id,object.device_feature_model.stat_key,object.device.device_type_id,,object.device_feature_model.value_type,object.device.address,object.device_feature_model.parameters,object.device_feature_model.name,object.device.name];
                    if (object.device_feature_model.feature_type == "actuator"){
                       $('select#sortieVrai').append("<option value='"+i+"'>"+object.device.name+" - "+object.device_feature_model.name+"</option>");
                    }
                    if (object.device_feature_model.name != "Trigger"){
                       $('select#features1').append("<option value='"+i+"'>"+object.device.name+" - "+object.device_feature_model.name+"</option>");
                    }
                    i=i+1;
                    });
                
         
                $("select#sortieFaux").append($("select#sortieVrai").clone().html());
           })
            .fail(function(jqXHR, status, error){
                if (jqXHR.status == 400)
                    $.notification('error', "{% trans "Device list not retrieved" %} (" + jqXHR.responseText + ")");
            });
          $("select#features2").hide();
          $("select#test2").hide();
          $("select#features1").change();
     });
});

</script>
<section class="subsection">
    <h2>{% trans "Created Scene" %}</h2>
    <h3>{% trans "If" %}</h3>   
    <div>
    <select id="features1" class='listes' style="width:30em;"></select>
    <select id="test1" class='listes' style="width:10em;">
    <option value="None">----</option>
    <option value=">">></option>
    <option value="<"><</option>
    <option value="=">=</option>
    </select>
    <span id="value1"></span>
    </div>
    <div>
    <select id="TestFeature" class='listes' style="width:10em;">
    <option value="None">----</option>
    <option value="And">And</option>
    <option value="Or">Or</option>
    </select>
    </div>
    <div>
    <select id="features2" class='listes' style="width:30em;"></select>
    <select id="test2" class='listes' style="width:10em;">
    <option value="None">None</option>
    <option value=">">></option>
    <option value="<"><</option>
    <option value="=">=</option>
    </select>
    <span id="value2" style="width:30em;"></span>
    </div>
    <div>
    <h3>{% trans "then" %}</h3>
    <select id="sortieVrai" class='listes' style="width:30em;"></select> =>
    <span id="valvrai"></span>
    <h3>{% trans "else" %}</h3>
    <select id="sortieFaux" class='listes' style="width:30em;"></select> =>
    <span id="valfaux"></span>
    </div>
    <h3>{% trans "Interval" %}</h3>
    <input id="tempo"></input>
    <p>
    <button id="Creator" class='button icon16-action-save' style="width:20em;">{% trans "Create" %}</button>
    Rinor Url :{{ request.session.rinor_ip }}:{{ request.session.rinor_port }}</p> 
</section>
