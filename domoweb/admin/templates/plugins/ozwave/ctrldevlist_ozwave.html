{% comment %}
# Copyright 2012 Domogik project

# This file is part of Domogik.
# Domogik is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.

# Domogik is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.

# You should have received a copy of the GNU General Public License
# along with Domogik.  If not, see <http://www.gnu.org/licenses/>.

# Plugin purpose 
# ==============
# Support Z-wave technology
# Implements user interface for domoweb
# ==============
# Author : Nico <nico84dev@gmail.com>
{% endcomment %}

{% load i18n %}
{% load text %}

<script type="text/javascript" src="{% url django.views.i18n.javascript_catalog %}"></script>
<script type="text/javascript" src="{{ static_design_url }}/libraries/jquery.qtip-1.0.0-rc3/jquery.qtip-1.0.0-rc3.min.js"></script>
<script type="text/javascript" src="{{ static_design_url }}/libraries/jquery.dataTables-1.8.2/js/jquery.dataTables.min.js"></script>
<script type="text/javascript" src="{{ static_design_url }}/admin/js/page-admin-ozwlib.js"> </script>
<script type="text/javascript" src="{{ static_design_url }}/admin/js/page-admin-ozwkinetics.js"> </script>
<script type="text/javascript" src="{{ static_design_url }}/admin/js/page-admin-ozwdialogs.js"> </script>
<script type="text/javascript" src="{{ static_design_url }}/admin/js/page-admin-ozwdlgctrlaction.js"> </script>

<link href="{{ static_design_url }}/admin/css/page-admin-datatable_paginate.css" rel="stylesheet" type="text/css" />

<script type='text/javascript'>

   $(function(){
    var infoNode ={};
    var devices = new Array();

    function dlgNodeAss (vData) {
        var d = "{{ static_design_url }}";
        $('#divNodeAssDialog').dialog_association({
        tips: "{% trans 'Node associations groups : ' %}" ,
        st_design_url: d
        } );

        $('#divNodeAssDialog').dialog_association('open',{
                title: 'Node ' + vData.Node  +' : {% trans "Edit associations groups." %} ',
                node: vData,
                onok: function(values) {
                    var self = this;
                    var v = $('#divNodeAssDialog').dialog_association('setnewgroups', this);
                    console.log("envois de la commande......");
                    setGroupsNode(v.stage, v.node, v.newgrps, RefreshGroups);
                    }
            });
        }
        
    function setStatusZW(status) {
        if (status=='up') { //active
            textstatus = "En cours d'execution";
        } else { //inactive
            textstatus = "Stoppé";
        }
        $("#iconstatuszw").empty()
            .attr('class', "icon16-text-right icon16-status-plugin-" + status)
            .html("<span class='label'>Etat:</span><span class='offscreen'>" + textstatus + "</span>");
        }
        
    function GetinfoValuesNode (nodeid, callback) {
        var valuesNode = [];
        var messXpl = {};
        if (nodeid) {
                var msg = {};
                msg['command'] = "Refresh";
                var val = {};
                val['request'] ='GetNodeValuesInfo';
                val['node'] =nodeid;
                msg['value'] = SetDataToxPL (val);
                rinor.put(['api', 'command', 'ozwave', 'UI'], msg)
                    .done(function(data, status, xhr){
                        messXpl = ParseAckXPL(data.xpl);
                        if (messXpl['count'] != 0) {
                            var thOut = Object.keys(messXpl['value0']);  // Hypothèse, vrais pour l'intant, toutes les lignes on les mêmes entêtes !
                            thOut.unshift('Num', 'realValue');
                            var RowN = [];
                            var hdCmdClss = {};
                            for (i=0; i<thOut.length; i++) {
                                hdCmdClss[thOut[i]]= i;
                                };
                            for (i=0; i<messXpl.count; i++) {
                                valuesNode[i]= messXpl['value' + i];
                                var R = [];
                                R[0] = i + 1;
                                try {
                                    R[1] = valuesNode[i]['value'];
                                    for (ii=2; ii<thOut.length;ii++) {
                                        R[ii] = valuesNode[i][thOut[ii]]
                                    };
                                } catch (err) {
                                    R[1] = 'Error';
                                    for (ii=2; ii<thOut.length;ii++) {
                                        R[ii] = 'no data';
                                    };
                                    R[3] = err;
                                    R[6] = 'Error';
                                    R[7] = 'Value lost during Xpl rinor transmission';
                                    R[16] = "";
                                };
                                RowN[i] = R;
                            };
                            console.log("Dans GetinfoValuesNode : " + RowN);
                            callback(thOut);
                            var idDetNode = '#detNode' + nodeid;
                            $(idDetNode).dataTable({
                                    "bFilter": false,
                                    "bJQueryUI": true,
                                    "aLengthMenu": [[10, 25, 50, -1], [10, 25, 50, "All"]],
                                    "bAutoWidth": false,
                                    "aoColumnDefs": [  
                                        { "fnRender": function (oObj) {return renderCmdClssNode(oObj);}, "aTargets": [0] },
                                        { "fnRender": function (oObj) {return renderCmdClssValue(oObj);}, "aTargets": [hdCmdClss['value']] },                                                           
                                        { "fnRender": function (oObj) {return renderCmdClssName(oObj);}, "aTargets": [hdCmdClss['commandClass']] },
                                        ], 
                                    "fnDrawCallback": function( oSettings) {
                                        handleChangeVCC();
                                        var iId = getDataTableColIndex(oSettings, 'id');
                                        var vId = '';
                                        var start = oSettings._iDisplayStart;
                                        var stop =  oSettings._iDisplayEnd;
                                        for (i=start; i<stop; i++) {
                                            vId = RowN[i][iId]
                                            createToolTip('#st' + vId, 'bottom');
                                            createToolTip('#hn' + vId, 'bottom');
                                            createToolTip('#adr' + vId, 'bottom');
                                            createToolTip('#hc' + vId, 'top');
                                            };
                                        for (i=0; i<thOut.length; i++) {
                                            if (thOut[i] == 'realValue' | thOut[i] == 'nodeId' | thOut[i] == 'homeId' | thOut[i] == 'domogikdevice' | thOut[i] == 'help' | thOut[i] == 'readOnly' | thOut[i] == 'listElems' | thOut[i] == 'id') {
                                                $(idDetNode).dataTable().fnSetColumnVis( i, false ); };
                                            }
                                    },
                                    "sPaginationType": "full_numbers",
                                    "aaData": RowN
                                    });
                           return valuesNode;
                        }  else { // le Node n'as pas de command_class
                            var thOut =[];
                            thOut[0]="No Command_Class";
                            console.log("Dans GetinfoValuesNode no Cmd-Class : " + thOut);
                            callback(thOut);                                                    
                        };
                    })
                    .fail(function(jqXHR, status, error){
                       if (jqXHR.status == 400)
                            $.notification('error', "{% trans "Data not sent" %} (" + jqXHR.responseText + ") please check your device configuration");
                            valuesNode['Node'] =   nodeid;
                            valuesNode['Model'] = "NodeId not define";
                            return valuesNode;
                    });
        }else { valuesNode['Model'] = "NodeId not define";
                console.log("Dans GetinfoValuesNode  pas de nodeid : " + nodeid);   
                return valuesNode;
                } 
        };

    $("#specialsubmit").click(function(){
        var dmg_addr = $("#dmg_addr").val();
        var info_node = 'Actualiser';
        var msg = {};
        netWorkZW ={};
        listNodes = [];
        setStatusZW('down');
        msg['command'] = "Refresh";
        var val = {};
        val['request'] ='GetNetworkID';
        msg['value'] = SetDataToxPL (val);
        rinor.put(['api', 'command', 'ozwave', 'UI'], msg)
            .done(function(data, status, xhr){
                netWorkZW =GetDataFromxPL(data, 'data');
                $('#confpath').html(netWorkZW['ConfigPath']);                    
                $('#userpath').html(netWorkZW['UserPath']);                    
                $('#libozwvers').html(netWorkZW['PYOZWLibVers']);
                $('#ozwplugvers').html(netWorkZW['OZWPluginVers']);
                if (netWorkZW['error'] ==""){
                    $('#homeid').html(netWorkZW['HomeID']);
                    $('#namectrl').html(netWorkZW['Model']);
                    $('#deviceadr').html(netWorkZW['Device']);
                    $('#numnodes').html(netWorkZW['Node count']);
                    $('#libctrl').html(netWorkZW['Library']);
                    $('#libctrlver').html(netWorkZW['Version']);                    
                    console.log("Dans Submit, .done: " + netWorkZW['Model']);
                    setStatusZW('up')
                    $.notification('debug',"device : " + netWorkZW['Primary controller'] + " info refreshed" );
                    var node_items = document.getElementById("node_items");
                    RefreshNodes(netWorkZW);
                } else {
                    $('#homeid').html(netWorkZW['error']);
                    setStatusZW('down')
                }
            })
            .fail(function(jqXHR, status, error){
                $('#homeid').html("{% trans "Plugin not running" %}");
                setStatusZW('down')
                if (jqXHR.status == 400)
                    $.notification('error', "{% trans "Data not sent" %} (" + jqXHR.responseText + ") please check your device configuration");
           });
        });
    
    function RefreshNodes(netWorkZW) {
           console.log("Dans RefreshNode, après .done" + JSON.stringify(netWorkZW));
            if (netWorkZW.ListNodeId) {
                var queue = netWorkZW.ListNodeId.slice(1);
                GetinfoNode(netWorkZW.ListNodeId[0], RefreshTabHtml, queue );
            };
        };
            
    function RefreshTabHtml(zwNode) {
      if (zwNode) {  
        console.log("Dans RefreshTabHtml, " + JSON.stringify(zwNode));
        var node_items = document.getElementById("node_items");
        var nodeid=zwNode.Node;
        var iid= "node_" + nodeid;
        var dataT = $('#node_items').dataTable().fnGetData();
        var dataLi = [zwNode.Node, zwNode.Name, zwNode.Location, zwNode.Model, zwNode['State sleeping'], zwNode.Type, zwNode['Last update'],""];
        var li= -1;
        if (dataT) {
            for (i=0; i<dataT.length; i++) {
                if (dataT[i][hdLiNode['NodeId']]==nodeid) {
                    li= i;
               //     $('#node_items').dataTable().fnUpdate(dataLi,li);   fnUpdate bugg si mise à jour de toute la ligne !!!!
                    for (var ic = 0; ic<dataLi.length; ic++){ 
                        $('#node_items').dataTable().fnUpdate(dataLi[ic], li, ic);
                        };
                    break;
                };
            };
        };
        if (li == -1) {
            $('#node_items').dataTable().fnAddData(dataLi);
            };
        console.log("Dans RefreshTabHtml, DataTable : " + dataT[li] + "---" + zwNode.Model); 
     }; 
    };   
     

// Callback event des commandes dans la table des nodes.
// Class button, 
    $('#node_items tbody td button').live('click', function () {
        var nTr = this.parentNode.parentNode;
        var aData = oTabNodes.fnGetData( nTr );
        if (this.name =='Update node') {
            console.log("Dans click updatenode, DataTable : " + aData);   
            // Lancer la sauvegarde vers plugin
                var msg = {};
                msg['command'] = "Refresh";
                var val = {};
                val['request'] ='SetNodeNameLoc';
                val['node'] =aData[hdLiNode['NodeId']];
                val['newname'] = returnTextValue(aData[hdLiNode['Name']]);
                val['newloc'] = returnTextValue(aData[hdLiNode['Location']]);
                msg['value'] = SetDataToxPL (val);
                rinor.put(['api', 'command', 'ozwave', 'UI'], msg)
                    .done(function(data, status, xhr){
                        infoNode = GetDataFromxPL(data,  'data');
                        var dt=JSON.stringify(infoNode);
                        console.log("Dans Update Node : " + infoNode['Model']);
                        $.notification('debug',"Node : " + infoNode['Model'] + " name and  location update" );
                        RefreshTabHtml(infoNode);
                        return  infoNode;
                    })
                    .fail(function(jqXHR, status, error){
                       if (jqXHR.status == 400)
                            $.notification('error', "{% trans "Data not sent" %} (" + jqXHR.responseText + ") {% trans "please check your device configuration" %}");
                            infoNode['Node'] =   nodeid;
                            infoNode['Model'] = "NodeId not define";
                            return infoNode;
                    });
        };
        if (this.name =='Detail node') {
            var t =  this.attributes["class"].value; //nodeValue
            if (t.search('action-del') != -1 ) {
			// This row is already open - close it 
                this.attributes["class"].value = "icon16-action-add buttonicon"; //nodeValue
                oTabNodes.fnClose( nTr );
            }else {
                // Open this row 
                this.attributes["class"].value = "icon16-action-del buttonicon"; //nodeValue
                //send update nodes values
                var values = GetinfoValuesNode(aData[hdLiNode['NodeId']], function(thOut){ oTabNodes.fnOpen( nTr, fnFormatDetails(nTr,thOut), 'simple' );});
        /*  console.log("click detail values : " + values); */
            };
        };
        if (this.name == 'Node groups') {
            var zwNode = GetZWNodeById(aData[hdLiNode['NodeId']]);
            editNodeAss(zwNode, dlgNodeAss);
            console.log("Dans click Node Associations, Node : " + zwNode.Node); 
         };
       if (this.name == 'Send value') {
            var idDetNode = nTr.parentNode.parentNode.id;
            var aTable = $('#' + idDetNode).dataTable();
            aData = aTable.fnGetData(nTr); 
            valueId = aData[getDataTableColIndex(aTable.fnSettings(), 'id')];
            console.log ("sending update cmd class");
            msg = setValueNode(valueId, aData[getDataTableColIndex(aTable.fnSettings(), 'value')], aTable,nTr);
            
        }else {
            console.log("Dans click button, DataTable : " + this.title); 
        };
    }); 
// class input   
$('#node_items tbody td input').live('keyup', function (e) {
   var nTr = this.parentNode.parentNode;
   var aData = oTabNodes.fnGetData( nTr );
   if (this.title =='Name') {
            aData[hdLiNode['Name']] = this.value;
            console.log("new value : " +aData);
        }
       else if (this.title =='Location') {
            aData[hdLiNode['Location']] = this.value;
            console.log("new value : " +aData);
        } else if (this.name =='CmdClssValue') {
                    console.log (" Dans Nom key down, CmdClssValue :" + nTr.id);
            } else {
                console.log("Dans Nom key down, input : " + this.title + "--" + this.value +"--" + this);
            };
});

    $("#specialsave").click(function(){
        var msg = {};
        msg['command'] = "Refresh";
 //       msg['value'] = "|'request':'SaveConfig'\\";
        msg['value'] = SetDataToxPL({"request":"SaveConfig"});
        rinor.put(['api', 'command', 'ozwave', 'UI'], msg)
            .done(function(data, status, xhr){
            $.notification('info',"Request : " + " saving config ok" );
            })
            .fail(function(jqXHR, status, error){
                if (jqXHR.status == 400)
                    $.notification('error', "{% trans "Data not sent" %} (" + jqXHR.responseText + ") please check your device configuration");
            });
    });

   $(document).ready(function(){
         oTabNodes = $("#node_items").dataTable({
            "bFilter": false,
            "bAutoWidth": false,
            "aoColumnDefs": [  
                { "fnRender": function (oObj) {
                    return setNameNode(oObj);}, "aTargets": [ hdLiNode['Name'] ] },
                { "fnRender": function (oObj) {
                    return  "<input type='text' title='Location' value='" + 
                                                oObj.aData[hdLiNode['Location']] + "'/>";}, "aTargets": [ hdLiNode['Location'] ] },
                { "fnRender": function (oObj) {
                    return setStatusSleep(oObj);}, "aTargets": [ hdLiNode['Awake'] ] },
                { "fnRender": function (oObj) {
                    return setTypeInfos(oObj);}, "aTargets": [ hdLiNode['Type'] ] },
                { "fnRender": function (oObj) {
                    return setActionNode(oObj);}, "aTargets": [hdLiNode['Action'] ] },      
                { "bSortable": false, "aTargets": [ hdLiNode['Action'] ] }, 
                ],
            "aaSorting": [[0, 'asc']]
            } );
        var msg = {};
        msg['command'] = "Refresh";
        var val = {};
        val['request'] ='GetListCmdsCtrl';
        val['listetypes'] ='cmdsctrl';
        msg['value'] = SetDataToxPL (val);
        rinor.put(['api', 'command', 'ozwave', 'UI'], msg)
            .done(function(data, status, xhr){
                var messXpl = ParseAckXPL(data.xpl);
                if (messXpl['error'] ='ok') {
                    var i =1; 
                    var nCmd={};
                    for (item in messXpl) {
                        if ('item'+i == item ) {
                            nCmd = Object.keys(messXpl['item'+i]);
                            listCmdCtrl[nCmd[0]] = messXpl['item'+i][nCmd[0]];
                            i = i+ 1;
                        };
                    }
                };    
                console.log("*** listCmdCtrl : " + listCmdCtrl);
                $("#specialsubmit").click();
                var items=[];
                for (cmd in listCmdCtrl) {
                     items.push({value: cmd, label: cmd , title:  listCmdCtrl[cmd], icon: 'icon16-technology-ozwave'});
                    }; 
                dlgCtrlAction(items);
          //      $('*[title]').tooltip_right();
                })
            .fail(function(jqXHR, status, error){
               if (jqXHR.status == 400)
                    $.notification('error', '{% trans "Data not recept" %} (' + jqXHR.responseText + ') please check your device configuration');
                    $("#specialsubmit").click();
            });
    });
});


</script>
<section class="subsection" id="zwnetworksection">

    <h2>{% trans "Zwave controller" %}  &nbsp;&nbsp;&nbsp;&nbsp;
            <div id='iconstatuszw'> <span class='label'>{% trans "Status"%}:</span>
          </div><div align="right"><font size=2>
                <span class='subtitle' id='libozwvers'><u>{% trans "Undefined"%}</u></span>&nbsp;&nbsp;&nbsp;&nbsp;
                <span class='label'>{% trans "Plugin version" %}:</span>&nbsp;<span class='subtitle' id='ozwplugvers'><u>{% trans "Undefined"%}</u></span>
            </font></div>
            </h2>
        <form id='controllerform'>
            <ul class='infos'>
                <li><font size=3>
                    <span class='label'>{% trans "Home ID" %}:</span>&nbsp;<span class='subtitle' id='homeid'><u>{% trans "Undefined" %}</u></span>
                </font> </li>
                 <li>
                    <span class='label'>{% trans "Contoller" %}:</span>&nbsp;<span class='subtitle' id='namectrl'><u>{% trans "Undefined" %}</u></span>
                    &nbsp;&nbsp;&nbsp;<span class='label'>{% trans "Device" %}:</span>&nbsp;<span class='subtitle' id='deviceadr'><u>{% trans "Undefined" %}</u></span>
                    &nbsp;&nbsp;&nbsp;<span class='label'>{% trans "Number of nodes" %}:</span>&nbsp;<span class='subtitle'  id='numnodes'><u>{% trans "Undefined" %}</u></span>
                </li>
                <li>
                    <span class='label'>{% trans "Library" %}:</span>&nbsp;<span class='subtitle'  id='libctrl'><u>{% trans "Undefined" %}</u></span>
                    &nbsp;&nbsp;&nbsp;<span class='label'>{% trans "Version" %}:</span>&nbsp;<span class='subtitle'  id='libctrlver'><u>{% trans "Undefined" %}</u></span>
                </li>
                <li>
                    <span class='label'>{% trans "Openzwave path configuration" %}:</span>&nbsp;<span class='subtitle' id='confpath'><u>{% trans "Undefined" %}</u></span>
                </li>
                <li>
                   <span class='label'>{% trans "User path" %}:</span>&nbsp;<span class='subtitle' id='userpath'><u>{% trans "Undefined" %}</u></span>
                </li>
            </ul>
        </form>
        <p>
            <button id='specialsubmit' class='button icon16-action-reset'>{% trans "Refresh" %}</button>
            <button id='specialsave' class='button icon16-action-save'>{% trans "Save config" %}</button> 
            <span class='subtitle'>{% trans " Updade Node button before saving" %}</span>
            <button id='ctrlactions' class='button icon16-action-customize'>{% trans "Controller Actions" %}</button> 
        </p>
</section>
<section class="subsection">
    <h2>{% trans "Zwave Network device" %}</h2>
    <table class='simple'><tbody>
        <tr>
            <td>{% trans "Description of zwave network with devices capacities" %}</td>
            <td></td>
            <td class='value icon16-status-primary'></td>
            <td> {% trans "Command Class available for domogik device" %}</td>
        </tr>
        <tr><td></td><td></td>
            <td class='value icon16-status-false'></td>
            <td> {% trans "Command Class not available for domogik device" %}</td>
         </tr>   
    </tbody></table>
    <p></p>
        <div id='networkform'>
            <table id='node_items' class='simple'>
                <thead>
                    <tr>
                        <th scope='col'>{% trans "NodeId" %}</th>
                        <th scope='col'>{% trans "Name" %}</th>
                        <th scope='col'>{% trans "Location" %}</th>
                        <th scope='col'>{% trans "Model" %}</th>
                        <th scope='col'>{% trans "Awake" %}</th>
                        <th scope='col'>{% trans "Type" %}</th>
                        <th scope='col'>{% trans "Last update" %}</th>
                        <th scope='col'>{% trans "Action" %}</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
        </table>
        </div>
</section>
<div id="divNodeAssDialog"></div>
<div id="divCtrlActionDialog"></div>
