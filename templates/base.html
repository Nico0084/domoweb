<!DOCTYPE html>
<html lang="en" class="csstransforms">
<head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta http-equiv="Cache-Control" content="no-cache" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="-1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Domoweb</title>
  <link rel="stylesheet" href="/libraries/bootstrap-3.2.0/css/bootstrap.min.css">
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="/css/menu.css">
  <style type="text/css" id="sectionstyle" shim-shadowdom>
  body {
    background-position: {{ params['SectionBackgroundPosition'] }};
    background-repeat: {{ params['SectionBackgroundRepeat'] }};
    background-size: {{ params['SectionBackgroundSize'] }};
    background-image: {% if 'SectionBackground' in params %}url('/backgrounds/{{params['SectionBackground']}}'){% else %}{{ params['SectionBackgroundImage'] }}{% end %};
  }
  body /deep/ .widget.style-general {
    border: 1px solid {{ params['WidgetBorderColor'] }};
    background-color: {{ params['WidgetBackgroundColor'] }};
    border-radius: {{ params['WidgetBorderRadius'] }};
    color: {{ params['WidgetTextColor'] }};
    box-shadow: {{ params['WidgetBoxShadow'] }};
  }
  </style>
  <script src="/components/platform/platform.js"></script>
  <link rel="import" href="/components/polymer-ajax.html">
  <link rel="import" href="/components/websockets.html">
  <link rel="import" href="/components/widget.html">
  <link rel="import" href="/components/section.html">
  <!--link rel="import" href="/components/mainMenu.html"-->
  <link rel="import" href="/components/gridLayout.html">
  <link rel="import" href="/components/widgetsSelector.html">
  {% for widget in widgets %}
  <link id="{{widget.id}}" rel="import" href="/widget/{{widget.set_id}}/{{widget.set_ref}}.html">
  {% end %}
  {% for instance in instances %}
    {% if instance.widget.default_style %}
    <style id="style-instance-{{instance.id}}" type="text/css">
      #instance-{{instance.id}} {
      {% if 'WidgetBackgroundColor' in instance.optionsdict %}background-color: {{ instance.optionsdict['WidgetBackgroundColor'] }};{% end %}
      {% if 'WidgetBorderColor' in instance.optionsdict %}border: 1px solid {{ instance.optionsdict['WidgetBorderColor'] }};{% end %}
      {% if 'WidgetBorderRadius' in instance.optionsdict %}border-radius: {{ instance.optionsdict['WidgetBorderRadius'] }};{% end %}
      {% if 'WidgetTextColor' in instance.optionsdict %}color: {{ instance.optionsdict['WidgetTextColor'] }};{% end %}
      {% if 'WidgetBoxShadow' in instance.optionsdict %}box-shadow: {{ instance.optionsdict['WidgetBoxShadow'] }};{% end %}
      }
    </style>
    {% end %}
  {% end %}
</head>
<body unresolved>
  <web-socket id="socket"></web-socket>
  <polymer-ajax id="ajax" method="POST" url="/configuration"></polymer-ajax>
  <dmw-section class='mainsection' sectionid="{{ section.id }}"></dmw-section>
	<main role="main">
    <dmw-grid-layout sectionid="{{section.id}}">
    {% for instance in instances %}
        <dmw-{{instance.widget.set_id}}-{{instance.widget.set_ref}} id="instance-{{instance.id}}" class="widget loading widgetw{{instance.widget.width}} widgeth{{instance.widget.height}}{% if instance.widget.default_style %} style-general{% end %}" tabindex=0 instanceid={{instance.id}}{% if instance.widget.default_style %} default_style=true{% end %}></dmw-{{instance.widget.set_id}}-{{instance.widget.set_ref}}>
    {% end %}
    </dmw-grid-layout>
    <button class="cn-button" id="cn-button"><span class='sr-only' data-i18n="menu.open"></span></button>
    <div class="cn-wrapper" id="cn-wrapper">
     <ul>
       <li><a id="menuConfigure" href="#" role='button'><span class="label" data-i18n="menu.configuration"></span><span class="icon glyphicon glyphicon-cog" aria-hidden="true"></span></a></li>
       <li><a id="menuWidgets" href="#" role='button'><span class="label" data-i18n="menu.widgets"></span><span class="icon glyphicon glyphicon-th" aria-hidden="true"></span></a></li>
       <li><a href="#" role='button'><span class="label" data-i18n="menu.home"></span><span class="icon glyphicon glyphicon-home" aria-hidden="true"></span></a></li>
       <li><a href="#" role='button'></a></li>
       <li><a href="#" role='button'><span class="label" data-i18n="menu.lock"></span><span class="icon glyphicon glyphicon-lock" aria-hidden="true"></span></a></li>
     </ul>
   </div>
   <div id="cn-overlay" class="cn-overlay"></div>
   <div id="modal-overlay"></div>
	</main>
  <script src="/libraries/jquery-1.11.0/jquery.min.js"></script>
  <script src="/libraries/bootstrap-3.2.0/js/bootstrap.min.js"></script>
  <script type="text/javascript" src="/libraries/i18next/i18next.min.js"></script>
  <script src="/libraries/d3/d3.min.js"></script>
  <script src="/js/menu.js"></script>
  <script type="text/javascript">
    var section = document.querySelector('.mainsection');
    var socket = document.querySelector('#socket');
    var layout = document.querySelector('dmw-grid-layout');
    window.addEventListener('polymer-ready', function(){
      socket.register('widgetinstance-added', instanceAdded, 'section_id', {{ section.id }});
      socket.register('widgetinstance-removed', instanceRemoved, 'section_id', {{ section.id }});        
    });
    window.onload=function() {
      section.addEventListener('section-updated', sectionUpdated);
    };

    i18n.init({
      load: 'current',
//        lng: "en-US",
      fallbackLng: 'en-US',
      resGetPath: 'locales/__ns__/__lng__/translation.json',
      ns: {
        namespaces: ['domoweb', {% for pack in packs %}'{{pack[0]}}', {% end %}], 
        defaultNs: 'domoweb'
        },
      },
      function() {
      // translate nav
      jQuery("#cn-wrapper").i18n();
    });
    function sectionUpdated(e) {
      var ss = document.querySelector('#sectionstyle');
      var bodyStyle = ss.sheet.cssRules[0];
      if ('SectionBackground' in section.params) {
          bodyStyle.style.backgroundImage="url('/backgrounds/" + section.params['SectionBackground'] + "')";
      } else {
          bodyStyle.style.backgroundImage=section.params['SectionBackgroundImage'];
      }
      var widgetStyle = ss.sheet.cssRules[1];
      widgetStyle.style.color=section.params['WidgetTextColor'];
      widgetStyle.style.backgroundColor=section.params['WidgetBackgroundColor'];
      widgetStyle.style.borderColor=section.params['WidgetBorderColor'];
      widgetStyle.style.borderRadius=section.params['WidgetBorderRadius'];
      widgetStyle.style.boxShadow=section.params['WidgetBoxShadow'];
    }
    function instanceAdded(topic, json) {
      var link = document.head.querySelector("link#" + json.widget_id);
      if (!link) { // If widget pack not already loaded
        link = document.createElement('link');
        link.setAttribute('rel', "import");
        link.setAttribute('href', "/widget/" + json.widget.set_id + '/' + json.widget.set_ref + ".html")
        document.head.appendChild(link);
      }

      var tag = 'dmw-' + json.widget.set_id + '-' + json.widget.set_ref;
      var widget = document.createElement(tag);
      widget.id = "instance-" + json.id
      widget.classList.add("widget", "loading", "widgetw" + json.widget.width, "widgeth" + json.widget.height);
      if (json.widget.default_style) { // If we load the default style
        widget.classList.add("style-general");
        widget.setAttribute('default_style', true);
      }
      widget.setAttribute('jsonid', json.id);
      widget.setAttribute('tabindex', 0);
      if (layout.getAttribute('edit') != null) {
        widget.setAttribute('edit', '');
      }
      layout.appendChild(widget);
    }
    function instanceRemoved(topic, json) {
      var widget = document.querySelector('#instance-' + json.id);
      widget.remove();
    }
  </script>
</body>
</html>

