<link rel="import" href="/widget/google_maps/google-maps-api.html">

<polymer-element name="dmw-google_maps-map_square" extends="dmw-widget">
    <template>
        <google-maps-api id="mapsapi" apiKey="AIzaSyArPfDsI7f6bMEQ_VSqwtG4pSw5bTmAv6Y" version="3.exp"></google-maps-api>
        <link rel="stylesheet" href="/widget/google_maps/css/common.css" shim-domshadow>
        <style type="text/css">
            :host {
                height: 100%;
                display: block;
            }
            #map {
                height: 100%;
                display: block;
            }
        </style>
        <dmw-sensor id='primary' sensorkey="primary" sensorvalue="{{sensorvalue}}" sensorhistory="{{history}}"></dmw-sensor>
        <shadow></shadow>
        <div id='map'></div>
    </template>
    <script src="https://maps.googleapis.com/maps/api/js?key="></script>
    <script>
        Polymer('dmw-google_maps-map_square', {
            ready: function() {
                console.warn("ready");
                var self = this;
                this.super();
                this.map;
                this.markers = [];
                var self = this;
                this.$.mapsapi.addEventListener('api-load', function(e) {
                    console.warn("api load");
                    // this.api === google.maps
                    var mapOptions = {
                        zoom: 8,
                        center: new this.api.LatLng(47, 1)
                    };
                    self.map = new this.api.Map(self.$.map,
                        mapOptions);
                    console.warn("end api load");

                });
                console.warn("end ready");
            },
            sensorsUpdated: function() {
                if (this.$.primary.isSet) {
                    this.labelprimary = this.$.primary.device['name'];
                    this.labelsecondary = this.$.primary.name;
                }        
            },
            sensorvalueChanged: function(oldValue, newValue) {
                console.warn("sensorvalueChanged");
                this.deleteMarkers();
                this.addMarker(newValue);
            },
            historyChanged: function(oldValue, newValue) {
                console.warn("historyChanged");
            },

            // Add a marker to the map and push to the array.
            addMarker: function(location) {
                console.warn("addMarker for ", location);
                coords = location.split(",");
                gmap_location = new google.maps.LatLng(coords[1], coords[0]);
                this.map.setCenter(gmap_location);
                var marker = new google.maps.Marker({
                    position: gmap_location,
                    map: this.map,
                    title: this.$.primary.device['name'],
                    //animation: google.maps.Animation.DROP
                });
                this.markers.push(marker);
            },

            // Sets the map on all markers in the array.
            setAllMap: function(map) {
                console.warn("setAllMap");
                for (var i = 0; i < this.markers.length; i++) {
                    console.warn(this.markers[i]);
                    this.markers[i].setMap(map);
                }
            },

            // Removes the markers from the map, but keeps them in the array.
            clearMarkers: function() {
                console.warn("clearMarkers");
                this.setAllMap(null);
            },

            // Delete all the markers on the map
            deleteMarkers: function() {
                console.warn("deleteMarkers");
                this.clearMarkers();
                this.markers = [];
            }

            
        });


    </script>
</polymer-element>
