<link rel="import" href="/components/polymer/polymer.html">
<link rel="import" href="/components/sensor.html">
<link rel="import" href="/components/command.html">
<link rel="import" href="/components/datatypes.html">
<script src="/js/serialize-0.2.min.js"></script>

<polymer-element name="dmw-widget" attributes="instanceid edit debug">
	<template>
	    <web-socket id="socket"></web-socket>
	    <dmw-datatypes id="datatypes"></dmw-datatypes>
	    <polymer-ajax id="ajax" method="POST" url="/configuration"></polymer-ajax>
		<div id='labelprimary'>{{labelprimary}}</div>
		<div id='labelsecondary'>{{labelsecondary}}</div>
	    <template if="{{ edit!=null }}">
	    	<div class="editOverlay">
		    	<button class="editWidget" on-click="{{editWidget}}" aria-label="Edit"><span class="glyphicon glyphicon-cog" aria-hidden="true"></span></button>
		    	<button class="removeWidget" on-click="{{removeWidget}}" aria-label="Remove"><span class="glyphicon glyphicon-remove" aria-hidden="true"></span></button>
	    	</div>
	    </template>
	</template>
	<script>
		Polymer("dmw-widget", {
			ready: function() {
				this.sensorsReady = false;
				this.commandsReady = false;
				this.devicesReady = false;

				if (this.datatypes === null) {
					this.$.datatypes.addEventListener("datatype-received", this.datatypesReceived.bind(this));	
				}
			},
			removeWidget: function(e) {
		    	this.$.socket.send("widgetinstance-remove", {'instance_id':this.instanceid});
			},
			editWidget: function(e) {
				var self = this;
				var modalOverlay = document.querySelector('#modal-overlay');
				this.$.ajax.setAttribute('handleAs', 'text');
				this.$.ajax.addEventListener("polymer-response",
        			function(e) {
						var response = e.detail.response;
						if (response == '{success:true}') {
   							modalOverlay.classList.remove('on');
							modalOverlay.innerHTML = '';
						} else {
							modalOverlay.innerHTML = response;
							var saveConfig = modalOverlay.querySelector('#saveConfig');
							var cancelConfig = modalOverlay.querySelector('#cancelConfig');
							var formConfig = modalOverlay.querySelector('#formConfig');
							saveConfig.addEventListener("click",
								function(e) {
									self.$.ajax.setAttribute('body', serialize(formConfig));
									self.$.ajax.setAttribute('method', 'POST');
									self.$.ajax.setAttribute('params', '{"action":"widget", "id":"' + self.instanceid + '"}');
									self.$.ajax.go();
									e.preventDefault();
									e.stopPropagation();
									return false;
								});
							cancelConfig.addEventListener("click",
								function(e) {
   									modalOverlay.classList.remove('on');
									modalOverlay.innerHTML = '';
									e.preventDefault();
									e.stopPropagation();
									return false;
								});
							modalOverlay.classList.add('on');
						}
        			});
				this.$.ajax.setAttribute('method', 'GET');
				this.$.ajax.setAttribute('params', '{"action":"widget", "id":"' + this.instanceid + '"}');
				self.$.ajax.go();
			},
			instanceidChanged: function(oldValue, newValue) {
		    	this.$.socket.register('widgetinstance-options', this.optionsReceived.bind(this), 'instance_id', newValue);
		    	this.$.socket.send("widgetinstance-getoptions", {'instance_id': newValue});
		    	this.$.socket.register('widgetinstance-sensors', this.sensorsReceived.bind(this), 'instance_id', newValue);
		    	this.$.socket.send("widgetinstance-getsensors", {'instance_id': newValue});
		    	this.$.socket.register('widgetinstance-commands', this.commandsReceived.bind(this), 'instance_id', newValue);
		    	this.$.socket.send("widgetinstance-getcommands", {'instance_id': newValue});
		    	this.$.socket.register('widgetinstance-devices', this.devicesReceived.bind(this), 'instance_id', newValue);
		    	this.$.socket.send("widgetinstance-getdevices", {'instance_id': newValue});
			},
			datatypesReceived: function() {
				if (this.options && this.commandsReady && this.sensorsReady && this.devicesReady) this.paramsReady();
			},
			optionsReceived: function(topic, json) {
				this.options = json['options'];
				if (this.loadStyle === undefined || this.loadStyle === null || this.loadStyle === true) {
					this.style.border = '1px solid ' + this.options['WidgetBorderColor'];
	    			this.style.backgroundColor = this.options['WidgetBackgroundColor'];
	    			this.style.borderRadius = this.options['WidgetBorderRadius'];
	    			this.style.color = this.options['WidgetTextColor'];
	    			this.style.boxShadow = this.options['WidgetBoxShadow'];					
				}
				if (this.sensorsReady && this.commandsReady && this.devicesReady && this.datatypes) this.paramsReady();
			},
			sensorsReceived: function(topic, json) {
				for (var key in json['sensors']) {
					var sensor = json['sensors'][key];
					var dmwsensor = this.shadowRoot.querySelector('dmw-sensor[sensorkey="' + key + '"]');
					if (dmwsensor) {
						dmwsensor.init(sensor);
					}
				}
				this.sensorsReady = true;
				if (this.options && this.commandsReady && this.devicesReady && this.datatypes) this.paramsReady();
			},
			commandsReceived: function(topic, json) {
				for (var key in json['commands']) {
					var command = json['commands'][key];
					var dmwcommand = this.shadowRoot.querySelector('dmw-command[commandkey="' + key + '"]');
					if (dmwcommand) {
						dmwcommand.init(command);
					}
				}
				this.commandsReady = true;
				if (this.options && this.commandsReady && this.devicesReady && this.datatypes) this.paramsReady();
			},
			devicesReceived: function(topic, json) {
				for (var key in json['devices']) {
					var device = json['devices'][key];
					if ('sensors' in device) {
						for (var key in device['sensors']) {
							var dmwsensor = this.shadowRoot.querySelector('dmw-sensor[sensorkey="' + key + '"]');
							if (dmwsensor) {
								dmwsensor.init(device['sensors'][key]);
							}
						}
					}
					if ('commands' in device) {
						for (var key in device['commands']) {
							var dmwcommand = this.shadowRoot.querySelector('dmw-command[commandkey="' + key + '"]');
							if (dmwcommand) {
								dmwcommand.init(device['commands'][key]);
							}
						}
					}
				}
				this.devicesReady = true;
				if (this.options && this.commandsReady && this.sensorsReady && this.datatypes) this.paramsReady();
			},
			get datatypes() {
				return this.$.datatypes.list;
			},
			paramsReady: function() {}
		});
	</script>
</polymer-element>

