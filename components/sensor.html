<polymer-element name="dmw-sensor" attributes="sensorid sensorkey sensorvalue sensorhistory">
	<template>
	    <web-socket id="socket"></web-socket>
	</template>
	<script>
		Polymer("dmw-sensor", {
			ready:function(){
				this.isSet = false;
				this.checkdelay = 0;
				this.recheckdelay = 60000; // every minute
				this.timedout = false;
			},
			statReceived: function(topic, json) {
		        this.sensorvalue=json.stored_value;
		        this.sensorreceived=json.timestamp;
		        this.fire('sensor-statreceived', {stat: json});
				if (this.checkdelay > 0) {
			        // Remove interval recheck
			        if (this.intervalid) {
				        this.fire('sensor-timeoutend');
			        	window.clearInterval(this.intervalid);
			        	delete this.intervalid;
			        }
			        // Reset timeout
					if (this.timeoutid) {
					    window.clearTimeout(this.timeoutid);
						delete this.timeoutid;
					}
		    	   	this.timeoutid = window.setTimeout(this.timeoutHandler.bind(this), this.checkdelay);
			    }
		    },
			historyReceived: function(topic, json) {
		        this.sensorhistory=json['history'];
		    },
		    sensoridChanged: function(oldValue, newValue) {
		    	this.$.socket.register('device-stats', this.statReceived.bind(this), 'sensor_id', newValue);
		    	this.$.socket.register('sensor-history', this.historyReceived.bind(this), 'id', newValue);
				if (this.checkdelay > 0) {
			    	this.timeoutid = window.setTimeout(this.timeoutHandler.bind(this), this.checkdelay);
			    }
		    },
		    init: function(sensor) {
		    	this.checkdelay = parseInt(sensor['timeout']) * 1000; // Convert in millisec
		    	this.name = sensor['name'];
		    	this.sensorvalue = sensor['last_value'];
		    	this.sensorreceived = sensor['last_received'];
		    	this.sensorid = sensor['id'];
		    	this.device = sensor['device'];
		    	this.datatype_id = sensor['datatype_id'];
				this.isSet = true;
				if (this.checkdelay > 0) {
					var diff = moment.duration(moment().diff(moment.unix(this.sensorreceived)));
					console.debug(diff);
					if (diff > this.checkdelay) { // If the sensor already timed out
				        this.fire('sensor-timeout', {'minutes': diff.humanize()});
				        this.intervalid = window.setInterval(this.intervalHandler.bind(this), this.recheckdelay); // adjust time every 1 minute
					}					
				}
		    },
		    getHistory: function(from, to) {
		    	this.$.socket.send("sensor-gethistory", {'id': this.sensorid, 'from': from, 'to': to});
		    },
		    getLast: function(count) {
		    	this.$.socket.send("sensor-getlast", {'id': this.sensorid, 'count': count});
		    },
		    timeoutHandler: function() {
				var diff = moment.duration(moment().diff(moment.unix(this.sensorreceived)));
		        this.fire('sensor-timeout', {'minutes': diff.humanize()});
		    	if (this.timeoutid) { //Remove the timeout check...
			        window.clearTimeout(this.timeoutid);
		        	delete this.timeoutid;
		    	}
		    	// and replace it with regular recheck
		        this.intervalid = window.setInterval(this.intervalHandler.bind(this), this.recheckdelay); // adjust time every 1 minute 	
		    },
		    intervalHandler: function() {
				var diff = moment.duration(moment().diff(moment.unix(this.sensorreceived)));
		        this.fire('sensor-timeout', {'minutes': diff.humanize()});
		    }
		});
	</script>
</polymer-element>

