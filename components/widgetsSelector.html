<link rel="import" href="/libraries/polymer/polymer.html">
<link rel="import" href="/components/websockets.html">
<link rel="import" href="/components/sensor.html">

<polymer-element name="dmw-widgets-selector" attributes="section">
	<script src="/libraries/isotope/dist/isotope.pkgd.min.js"></script>
	<template>
  		<link rel="stylesheet" href="/libraries/bootstrap-3.2.0/css/bootstrap.min.css">
		<style type="text/css">
		::content article {
			padding: 0;
			margin: 0.5em;
			text-align: center;
			float: left;
			width: 20em;
		}
		::content article h2 {
			margin: 0;
			background: #428bca;
			color: #ffffff;
			font-size: 1em;
			padding: 0.5em;
			-moz-border-radius:  6px 6px 0 0;
			-webkit-border-radius:  6px 6px 0 0;
			border-radius: 6px 6px 0 0;
		}
		::content article .body {
			background: #F0F0F0;
			color: #000000;
			padding: 0.5em;
			height: 8em;
			position: relative;
		}
		::content article .body .overlay {
			position: absolute;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			background-color: rgba(0,0,0,0.6);
			padding: 1em;
			display: none;
		}
		::content article .body .overlay button {
			margin: 0.5em auto 0.5em auto;
			display: block;
		}
		::content article .body:hover .overlay,
		::content article .body:focus .overlay {
			display: block;
		}
		::content article img {
			max-width: 19em;
			max-height: 7em;
		}
		::content article .footer {
			margin: 0;
			background: #428bca;
			color: #ffffff;
			font-size: 1em;
			padding: 0.5em;
			-moz-border-radius:  0 0 6px 6px;
			-webkit-border-radius:  0 0 6px 6px;
			border-radius: 0 0 6px 6px;
			text-align: right;
			font-style: italic;
		}
		</style>
		<web-socket id="socket"></web-socket>
   	    <div id="container-fluid">
  			<div class="row">
				<div class="col-md-10 col-md-offset-1">
					<h1>Select Widget</h1>
					<button id="closeModal" type="button" class="btn btn-default">Close</button>
					<div id="filters" class="button-group">
					  	<button class="btn btn-default" data-filter="*">show all</button>
				    	<template repeat="{{s in sets}}">
					  		<button class="btn btn-default" data-filter=".{{s.id}}">{{s.name}}</button>
				  		</template>
					</div>

					<div id="widgetslist">
					    <template repeat="{{w in widgets}}">
			        	<article class="{{ w.set_id }}">
			        		<h2>{{ w.name }}</h2>
			        		<div class="body">
			        			<img src='/widget/{{ w.set_id }}/{{ w.set_ref }}.png'/>
				        		<div class="overlay"><button class="add-widget btn btn-success" on-click="{{addWidget}}" data-widget-id="{{ w.id }}">Add</button><button class="add-widget btn btn-success" on-click="{{addWidgetClose}}" data-widget-id="{{ w.id }}">Add and Close</button></div>
				        	</div>
				        	<div class="footer">{{ w.set_name }}</div>
			        	</article>
				      	</template>
					</div>
				</div>
			</div>   	
   	    </div>
	</template>
	<script>
		Polymer("dmw-widgets-selector", {
			ready:function(){
		    	this.$.socket.register('widget-list', this.messageReceived.bind(this), null, null);
				this.$.socket.send("widget-getall", null);
				this.iso = new Isotope( this.$.widgetslist, {
				  	itemSelector: 'article',
				  	layoutMode: 'fitRows',
				});
				var self = this;
				this.$.closeModal.addEventListener('click', function () {
					var modalOverlay = document.querySelector('#modal-overlay');
					modalOverlay.classList.remove('on');
					self.remove();
				});
			},
			messageReceived: function(topic, json) {
				var sets = [];
				this.sets = [];
				for (w in json) {
					if (sets.indexOf(json[w].set_id)==-1) {
						sets.push(json[w].set_id);
						this.sets.push({'id':json[w].set_id, 'name':json[w].set_name});
					}
				}
		        this.widgets = json;
		        var self = this;
		        this.async(
  					// `async` lets the main loop resume and perform tasks, like DOM updates,
				  	// then it calls your callback 
				  	function() {
						var buttons = self.$.filters.querySelectorAll('button');
						for (var i = buttons.length - 1; i >= 0; i--) {
							buttons[i].addEventListener('click', function () {
								var filterValue = this.dataset['filter'];
								self.iso.arrange({
								  filter: filterValue
								});
							});
						};
				        self.iso.reloadItems();
				        self.iso.arrange();
				  	}
				);
		    },
		    addWidget: function(e) {
		    	var widget_id = e.target.dataset.widgetId;
		    	this.$.socket.send("widgetinstance-add", {'widget_id':widget_id, 'section_id':this.section});
		    },
		    addWidgetClose: function(e) {
		    	var widget_id = e.target.dataset.widgetId;
		    	this.$.socket.send("widgetinstance-add", {'widget_id':widget_id, 'section_id':this.section});
				var modalOverlay = document.querySelector('#modal-overlay');
				modalOverlay.classList.remove('on');
				this.remove();
		    }
		});
	</script>
</polymer-element>