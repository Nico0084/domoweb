<link rel="import" href="/components/polymer/polymer.html">

<polymer-element name="web-socket">
	<script>
		var _socket = null;
		var _handler = null;
		function WebsocketHandler() {
			this.listeners = [];
		}

		WebsocketHandler.prototype.onMessage = function(msg) {
			console.log("WS: message received");
			console.log(msg.data);
			json = JSON.parse(msg.data);
			for ( var i=0; i < this.listeners.length; i++ ) {
				listener = this.listeners[i];
				if (json[0] == 'device-stats' 
					&& json[0] == listener[0] 
					&& json[1].sensor_id == listener[1]) {
					listener[2](json[0], json[1]);
				} else if (json[0] == 'widgetinstance-added' 
					&& json[0] == listener[0] 
					&& json[1].section_id == listener[1]) {
					listener[2](json[0], json[1]);
				} else if (json[0] == 'widgetinstance-removed' 
					&& json[0] == listener[0] 
					&& json[1].section_id == listener[1]) {
					listener[2](json[0], json[1]);
				} else if (json[0] == 'widgetinstance-sectionlist' 
					&& json[0] == listener[0] 
					&& json[1].section_id == listener[1]) {
					listener[2](json[0], json[1]);
				} else if (json[0] == 'widgetinstance-options' 
					&& json[0] == listener[0] 
					&& json[1].instance_id == listener[1]) {
					listener[2](json[0], json[1]);
				} else if (json[0] == 'widgetinstance-sensors' 
					&& json[0] == listener[0] 
					&& json[1].instance_id == listener[1]) {
					listener[2](json[0], json[1]);
				} else if (json[0] == 'widgetinstance-commands' 
					&& json[0] == listener[0] 
					&& json[1].instance_id == listener[1]) {
					listener[2](json[0], json[1]);
				} else if (json[0] == 'widget-list' 
					&& json[0] == listener[0]) {
					listener[2](json[0], json[1]);
				} else if (json[0] == 'datatype-list' 
					&& json[0] == listener[0]) {
					listener[2](json[0], json[1]);
				}			}
		};

		WebsocketHandler.prototype.beforeUnload = function() {
	       	_socket.onclose = function () {}; // disable onclose handler first
    	    _socket.close();
		};

		WebsocketHandler.prototype.subscribe = function(func, name, id) {
			this.listeners.push([name, id, func]);
		};

		WebsocketHandler.prototype.send = function(json) {
			var data = JSON.stringify(json);
			try {
				console.log("WS: sending message " + data);
				_socket.send(data);
			} catch(error) {
				console.log("cannot send message: error: " + error);
			}
		};

		Polymer("web-socket", {
			isConnected: false,
			ready:function(){
				//window.addEventListener('beforeunload', this.beforeUnload.bind(this));//buggy in chrome
				// Cleanly close websocket when unload window
				if (window.WebSocket) {
					if (_socket == null) {
						_handler = new WebsocketHandler;
						_socket = new WebSocket("ws://" + document.domain + ":40404/ws/");
						_socket.onmessage = _handler.onMessage.bind(_handler);
						_socket.onerror = this.onError.bind(this);
						_socket.onopen = this.onOpen.bind(this);
						window.onbeforeunload = _handler.beforeUnload.bind(_handler);
					}
				}
			},
			
			onOpen: function (e) {
		    	console.log('WS: Connection open');
				this.isConnected = true;
			    this.fire('websocket-ready');
			},
			onError: function (error) {
				console.error('There was an un-identified Web Socket error',error);
			},
			send: function(id, json) {
				_handler.send([id, json]);
			},
			register: function(name, id, func) {
				_handler.subscribe(func, name, id);
			},
		});
	</script>
</polymer-element>

