<style>
@font-face {
  font-family: 'FontAwesome';
  src: url('/libraries/font-awesome-4.5.0/fonts/fontawesome-webfont.eot?v=4.5.0');
  src: url('/libraries/font-awesome-4.5.0/fonts/fontawesome-webfont.eot?#iefix&v=4.5.0') format('embedded-opentype'), url('/libraries/font-awesome-4.5.0/fonts/fontawesome-webfont.woff2?v=4.5.0') format('woff2'), url('/libraries/font-awesome-4.5.0/fonts/fontawesome-webfont.woff?v=4.5.0') format('woff'), url('/libraries/font-awesome-4.5.0/fonts/fontawesome-webfont.ttf?v=4.5.0') format('truetype'), url('/libraries/font-awesome-4.5.0/fonts/fontawesome-webfont.svg?v=4.5.0#fontawesomeregular') format('svg');
  font-weight: normal;
  font-style: normal;
}
</style>

<link rel="import" href="/libraries/polymer/polymer.html">
<link rel="import" href="/components/websockets.html">

<polymer-element name="dmw-butler">
    <template>
        <style>
              @import '/libraries/bootstrap-3.3.5/css/bootstrap.min.css';
        </style>
        <link rel="stylesheet" href="/libraries/font-awesome-4.5.0/css/font-awesome.min.css" shim-domshadow>
        <style type="text/css">
            #background {
                /* background-color: blue; */
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                z-index: 0;
            }
            #speakButton {
                width: 6em;
                height: 6em;
                border-radius: 50%;
                border: 1px solid #ffffff;
                margin-top: 2em;
                margin-bottom: 2em;
                position: relative;
                left: 50%;
                -webkit-transform: translate(-50%, 0%);
                -ms-transform: translate(-50%, 0);
                transform: translate(-50%, 0);
                z-index: 1;
            }
            #speakButton span {
                position: relative;
                top: 50%;
                -webkit-transform: translate(-50%, -50%);
                -ms-transform: translate(-50%, -50%);
                transform: translate(-50%, -50%);
                left: 50%;
                text-align: center;
                display: inline-block;
            }
            #speech_errors {
                background: red;
                color: white;
                position: fixed;
                bottom: 4em;
                left: 5%;
                width: 90%;
                border-radius: 1em;
                padding: 1em;
            }

            #chat {
                font-size: 3em;
                list-style: none;
                margin-left: 0px;
                padding: 0 0 0 0;
            }
            @media screen and (max-width: 768px) {
                #chat {
                    font-size: 2em;
                    list-style: none;
                    margin-left: 0px;
                    padding: 0 0 0 0;
                }
            }
            #chat .itemUser {
                margin-bottom: 1em;
                border-right: 1px solid #ffffff;
                padding-right: 0.5em;
                text-align: right;
            }
           #chat .itemButler {
                margin-left: 0px;
                margin-bottom: 1em;
                border-left: 1px solid #ffffff;
                padding-left: 0.5em;
            }
            .box {
                /*
                border: 1px solid blue;
                */
            }

            /*** Animation ***/
            .pulse1 {
            	-webkit-animation: pulse1 2s linear infinite;
            	-moz-animation: pulse1 2s linear infinite;
            	-ms-animation: pulse1 2s linear infinite;
            	animation: pulse1 2s linear infinite;
            }
            
            @keyframes "pulse1" {
             0% {
                background-color: rgba(255,0,0,1.0);
             }
             50% {
                background-color: rgba(255,0,0,0.0);
             }
             100% {
                background-color: rgba(255,0,0,1.0);
             }
            
            }
            @-moz-keyframes pulse1 {
             0% {
               background-color: rgba(255,0,0,1.0);
             }
             50% {
               background-color: rgba(255,0,0,0.0);
             }
             100% {
               background-color: rgba(255,0,0,1.0);
             }
            
            }
            
            @-webkit-keyframes "pulse1" {
             0% {
               background-color: rgba(255,0,0,1.0);
             }
             50% {
               background-color: rgba(255,0,0,0.0);
             }
             100% {
               background-color: rgba(255,0,0,1.0);
             }
            
            }
            
            @-ms-keyframes "pulse1" {
             0% {
               background-color: rgba(255,0,0,1.0);
             }
             90% {
               background-color: rgba(255,0,0,0.0);
             }
             100% {
               background-color: rgba(255,0,0,1.0);
             }
            
            }
        </style>
        <web-socket id="socket"></web-socket>
        <div class="container">
          <div class="row">
            <div class="box col-md-12">
              <!-- <button id="closeModal" type="button" class="btn btn-default">Close</button> -->

              <div id="speakButton" on-click="{{startVoiceRecog}}">
                <span><i class="fa {{icon}} fa-3x"></i></span> 
                <!-- <span>SPEAK</span> -->
              </div>

              <ul id="chat">
                <li id="request" class="itemUser"><span>{{ request }}</span></li>
                <li id="butlerResponse" class="itemButler"><span>{{ butlerResponse }}</span></li>
              </ul>

            </div>
          </div>       
        </div>
        <div id="speech_errors">
          <div id="err_voices">{{err_voices}}</div>
          <div id="err_tts">{{err_tts}}</div>
          <div id="err_stt">{{err_stt}}</div>
        </div>

        <!-- big clicking zone to close the page when we click somewhere on it -->
        <div id="background" on-click="{{close}}">
        </div>
    </template>
    <script>
        Polymer("dmw-butler", {
            ready:function(){
                //this.voiceRecogInProgress = false;

                // Current status of the page
                /* Values : 
                        WAITING : do nothing, wait for the user to clic on the icon
                        STT     : voice recognition
                        CALLING_BUTLER : call the butler and wait for the response
                        TTS     : speaking



                           +---------------<-----------------------------+ error
                           |                                             |
                           |                                             |
                           |            +-------------<------------------+ auto continue dialog
                           |            |                                |
                           |            |                                |
                           |            |                                |
                        WAITING -----> STT -----> CALLING_BUTLER -----> TTS 
                           |            |   ok            |        ok
                           |            |                 |
                           |            |                 |
                           +----<-------+ error           |
                           |                              |
                           |                              |
                           |                              |
                           +-----------------<------------+ error
                */
                this.status = "WAITING"
                this.icon = "fa-microphone-slash";


                this.callback = Math.floor(Math.random() * 10000);
                this.$.socket.register('butler-discuss', this.tts.bind(this), { 'caller':this.callback });
                this.$.speech_errors.style.visibility = "hidden";

                // Hide the corner buttons
                document.getElementById('butler').style.visibility = "hidden";
                document.getElementById('main-menu').style.visibility = "hidden";
                document.getElementById('sections-tree').style.visibility = "hidden";


                doSTT = true;
                // display warning if no STT support :(
                if (!(window.hasOwnProperty('webkitSpeechRecognition'))) {
                    this.$.speech_errors.style.visibility = "visible";
                    this.err_stt = "Your browser doesn't support the Speech to Text feature!";
                    doSTT = false;
                }
                // display warning if no TTS support :(
                if (!('speechSynthesis' in window)) {
                    this.$.speech_errors.style.visibility = "visible";
                    this.err_tts = "Your browser doesn't support the Text to Speech feature!";
                }

                /* TODO : mieux gÃ©rer....
                console.error(speechSynthesis.getVoices());
                console.error(speechSynthesis.getVoices().length);
                if (speechSynthesis.getVoices().length == 0) {
                    this.$.speech_errors.show();
                    this.err_voices = "Your browser doesn't include any voice for the Text to Speech feature!";
                }
                */

                // On page display, start STT
                if (doSTT == true) {
                    this.startVoiceRecog();
                }
            },
            close: function(e) {
                // Redisplay the corner buttons
                document.getElementById('butler').style.visibility = "visible";
                document.getElementById('main-menu').style.visibility = "visible";
                document.getElementById('sections-tree').style.visibility = "visible";
                var modalOverlay = document.getElementById('modal-overlay');
                modalOverlay.classList.remove('on');
                this.remove();
            },
            startVoiceRecog: function(e) {
                if (window.hasOwnProperty('webkitSpeechRecognition')) {
                    // first, check if voice recnognition is already in process or not.
                    //if (this.voiceRecogInProgress == true) {
                    if (this.status == "STT") {
                        if (recognition) {
                            recognition.stop();
                        }
                        //this.voiceRecogInProgress = false;
                        this.status = "WAITING";
                        this.icon = "fa-microphone-slash";
                        return;
                    }
                    //this.voiceRecogInProgress = true;
                    this.status = "STT";
                    this.icon = "fa-microphone";

                    var recognition = new webkitSpeechRecognition();
                    recognition.continuous = false;
                    recognition.interimResults = false;
                    recognition.lang = "fr-FR";
                    this.$.speakButton.classList.add('pulse1');
                    recognition.start();

                    self = this;
                    recognition.onresult = function(e) {
                        recognition.stop();
                        //alert(e.results[0][0].transcript);
                        self.speaked = e.results[0][0].transcript;
                        self.displayRequest(self.speaked);

                        self.$.socket.send("butler-dodiscuss", {'caller': self.callback, 'data': {"text" : self.speaked, "source" : "domoweb"}});
                        //self.voiceRecogInProgress = false;
                        self.status = "CALLING_BUTLER";
                        self.icon = "fa-spinner";

                        //self.$.socket.send("butler-dodiscuss", {'caller': self.callback, 'text': self.speaked});
                        /* OLD url calling way ***************************************************
                        url = "http://192.168.1.50:50000/rest/butler/discuss";
                        $.ajax({
                           url: url,
                           type: 'GET',
                           dataType : 'jsonp',
                           crossDomain: true,
                           contentType: "application/json;",
                           success: function(data) {
                              //console.log("Response from butler="+data);
                              self.tts("butler-discuss", data, self.displayResponse(data), self.afterTts());
                              self.$.speakButton.classList.remove('pulse1');
                           },
                           error: function() {
                              self.$.speakButton.classList.remove('pulse1');
                              alert("Error while calling the butler component over the REST url");
                           },
                           data : {"data" : JSON.stringify({"text" : self.speaked, "source" : "domoweb"}, null, '\t')}
                        });
                        */

                    };

                    recognition.onend = function(e) {
                        self.status = "WAITING";
                        self.icon = "fa-microphone-slash";
                        //this.voiceRecogInProgress = false;
                        recognition.stop();
                        self.$.speakButton.classList.remove('pulse1');
                    }
                    recognition.onerror = function(e) {
                        self.status = "WAITING";
                        self.icon = "fa-microphone-slash";
                        //this.voiceRecogInProgress = false;
                        recognition.stop();
                        self.$.speakButton.classList.remove('pulse1');
                    }
                }
            },
            displayRequest: function(requestText) {
                this.request = requestText;
                // clean the previous butler response
                this.butlerResponse = "";
            },
            displayResponse: function(text) {
                this.butlerResponse = text;
            },
            tts: function(topic, json) {
                this.status = "TTS";
                this.icon = "fa-commenting-o";
                // topic is related to the WS usage
                // json is the json from the WS, so : ["butler-discuss", {"caller": 6516, "data": {"mood": null, "media": null, "sex": "female", "location": null, "text": "Salut", "reply_to": "Domoweb", "identity": "Aria"}}]


                console.log("Text to speak : " + json["data"]["text"]);
                var u = new SpeechSynthesisUtterance();
                u.text = json['data']['text'];
                u.lang = 'fr-FR';

                this.$.speakButton.classList.remove('pulse1');
                this.displayResponse(u.text);

                self = this;
                u.onend = function () {
                    self.afterTts();
                };
 
                u.onerror = function (e) {
                    self.status = "WAITING";
                    self.icon = "fa-microphone-slash";
                    alert('Error while speeaking');
                    console.error("Error while speaking : " + e);
                };

                console.error(u);
                speechSynthesis.speak(u);
            },
            afterTts: function() {
                this.startVoiceRecog(undefined);
            }
        });
    </script>
</polymer-element>
