<polymer-element name="dmw-grid-layout" attributes="sectionid edit">
	<template>
		<style type="text/css">
		    #container {
		      width: 80%;
		      margin: auto;
		      padding: 20px;
		    }
		    .widget {
		    	width:  100px;
  				height: 100px;
		    }
			.widget.widgetw2 { width: 200px; }
			.widget.widgeth2 { height: 200px; }
			.widget.widgetw3 { width: 300px; }
			.widget.widgeth3 { height: 300px; }		</style>
	    <web-socket id="socket"></web-socket>
	    <div id="container"></div>
	    <template if="{{ edit!=null }}">
	    	<button class="btn btn-primary btn-lg" on-click="{{addWidget}}">Add Widget</button>
	    </template>
	</template>
	<script src="/libraries/packery/dist/packery.pkgd.min.js"></script>
	<script>
		Polymer("dmw-grid-layout", {
			ready:function(){
				this.wall = new Packery( this.$.container, {
				  	// options
				  	itemSelector: '.widget',
				  	gutter: 20,
				});
//				this.wall.on( 'layoutComplete', this.orderChanged.bind(this) );
				this.wall.on( 'dragItemPositioned', this.orderChanged.bind(this) );
			},
			instanceAdded: function(topic, json) {
				this.appendInstance(json, true);
				this.wall.layout();
		    },
			instanceRemoved: function(topic, json) {
				var instance = this.shadowRoot.querySelector('*[instanceid="' + json['id'] + '"]');
				this.wall.remove(instance);
				this.wall.layout();
		    },
			listReceived: function(topic, json) {
				for (index = 0; index < json['instances'].length; ++index) {
					this.appendInstance(json['instances'][index], false);
				}
				this.wall.layout();
			},
			appendInstance: function(instance, edit) {
				var widget = document.createElement('dmw-' + instance.widget.set_id + '-' + instance.widget.set_ref);
				widget.classList.add('widget');
				widget.setAttribute('instanceid', instance.id);
				if (instance.widget.width > 1) {
					widget.classList.add('widgetw' + instance.widget.width);
				}
				if (instance.widget.height > 1) {
					widget.classList.add('widgeth' + instance.widget.height);
				}
				if (edit) {
					widget.setAttribute('edit', '');
				}
				this.$.container.appendChild(widget);
				this.wall.appended(widget);
			},
		    sectionidChanged: function(oldValue, newValue) {
		    	this.$.socket.register('widgetinstance-added', newValue, this.instanceAdded.bind(this));
		    	this.$.socket.register('widgetinstance-removed', newValue, this.instanceRemoved.bind(this));
		    	this.$.socket.register('widgetinstance-sectionlist', newValue, this.listReceived.bind(this));
		    	if (this.$.socket.isConnected) {
					this.$.socket.send("widgetinstance-getsection", {'section_id':newValue});
		    	} else {
	    			var socket = this.$.socket;
	    			socket.addEventListener('websocket-ready', function(e) {
						socket.send("widgetinstance-getsection", {'section_id':newValue});
  					});
		    	}
		    },
		    orderChanged: function() {
				var itemElems = this.wall.getItemElements();
				for ( var i=0, len = itemElems.length; i < len; i++ ) {
					var elem = itemElems[i];
					console.log( i + 1 );
				}
			},
			editChanged: function(oldValue, newValue) {
				widgets = this.$.container.childNodes;
				for (var i = 0; i < widgets.length; i++) {
				    var widget = widgets[i];
				    if (newValue != null) {
					    widget.setAttribute('edit', '');
				    } else {
				    	widget.removeAttribute('edit');
				    }
				}
			},
			addWidget: function(e) {
				var modalOverlay = document.querySelector('#modal-overlay'),
				selector = document.createElement('dmw-widgets-selector');
				selector.setAttribute('section', 1);
				modalOverlay.appendChild(selector);
				modalOverlay.classList.add('on');
			},
		});
	</script>
</polymer-element>